{% extends 'index.html' %}

{% block programmes_specific %}
<div class="container mt-5">
  <!-- En-tête du Programme -->
  <div class="d-flex justify-content-between align-items-start">
    <h2>{{ programme.nom }}</h2>
  </div>

  <!-- Statistiques sur le Programme et Fils Conducteurs -->
  <div class="d-flex justify-content-between align-items-start mb-4">
    <div>
      <p><strong>Total d'heures théoriques :</strong> {{ total_heures_theorie }} heures</p>
      <p><strong>Total d'heures pratiques :</strong> {{ total_heures_laboratoire }} heures</p>
      <p><strong>Total d'heures de travail à la maison :</strong> {{ total_heures_travail_maison }} heures</p>
      <p><strong>Total d'unités :</strong> {{ "%.2f"|format(total_unites) }}</p>
    </div>
    <div class="small text-muted text-end" style="max-width: 40%; margin-top: 0; display: flex; flex-wrap: wrap; gap: 0.5rem;">
      <h5 style="flex-basis: 100%;">Fils Conducteurs <a href="{{ url_for('main.add_fil_conducteur') }}" class="btn btn-sm btn-primary">Ajouter</a></h5>
      <ul class="list-inline mb-0">
        {% for fil in fil_conducteurs %}
          <li class="list-inline-item" style="background-color: {{ fil.couleur }}; color: {{ 'white' if fil.couleur else 'black' }}; padding: 0.2rem 0.5rem; border-radius: 0.2rem;">
            {{ fil.description }}
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- Grille des Cours par Session -->
  <div class="d-flex justify-content-between align-items-start mb-3">
    <h3 class="mb-0">Cours par session</h3>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-striped">
      <thead class="thead-dark">
        <tr>
          <th>Session</th>
          <th>Cours</th>
        </tr>
      </thead>
      <tbody>
{% for session, cours_list in cours_par_session.items() %}
<tr>
  <td>
    <div class="d-flex flex-column align-items-start">
      <span class="mb-2">{{ session }}</span>
      <a href="{{ url_for('plan_de_cours.export_session_plans', programme_id=programme.id, session=session) }}" 
         class="btn btn-sm btn-outline-primary" 
         title="Exporter tous les plans de cours de la session {{ session }}">
        <i class="fas fa-file-export"></i> Exporter tous les plans de cours
      </a>
    </div>
  </td>
  <td>
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-6">
      {% for c in cours_list %}
              <div class="col mb-3">
<div class="card h-100 d-flex flex-column">
<a href="{{ url_for('cours.view_cours', cours_id=c.id) }}"
   class="text-decoration-none d-flex align-items-center justify-content-center card-header"
   style="
       background-color: {{ c.fil_conducteur.couleur if c.fil_conducteur else '#f2f2f2' }};
       color: {{ 'white' if c.fil_conducteur else 'black' }};
       min-height: 3rem; 
       text-align: center; 
       word-wrap: break-word; 
       white-space: break-spaces; 
       overflow: hidden;
   ">
   <span><strong>{{ c.code }}</strong> - {{ c.nom }}</span>
</a>

                  <div class="card-body p-2 flex-grow-1">
                    <p><strong>Heures :</strong> {{ c.heures_theorie }} - {{ c.heures_laboratoire }} - {{ c.heures_travail_maison }}</p>
                    <p><strong>Compétences :</strong>
                      {% if competencies_codes[c.id] %}
                        {% for code in competencies_codes[c.id] %}
                          <a href="{{ url_for('programme.view_competence_by_code', competence_code=code) }}" class="badge bg-primary text-white">{{ code }}</a>
                        {% endfor %}
                      {% else %}
                        <em>Aucune</em>
                      {% endif %}
                    </p>
                    <p><strong>Prérequis :</strong>
                      {% if prerequisites[c.id] %}
                        {% for prereq, note in prerequisites[c.id] %}
                          {{ prereq }} ({{ note }}%)
                        {% endfor %}
                      {% else %}
                        <em>Aucun</em>
                      {% endif %}
                    </p>
                    <p><strong>Co-requis :</strong>
                      {% if corequisites[c.id] %}
                        {{ corequisites[c.id]|join(', ') }}
                      {% else %}
                        <em>Aucun</em>
                      {% endif %}
                    </p>
                  </div>

                  <!-- Boutons Plan-Cadre et Plan-de-cours -->
                  <div class="card-footer mt-auto text-center">
                    <!-- Bouton Plan-Cadre existant -->
                    <a href="{{ url_for('cours.view_or_add_plan_cadre', cours_id=c.id) }}" class="btn btn-sm btn-info w-100 fs-6 mb-2">
                      Plan-Cadre
                    </a>
                    <!-- Nouveau bouton Plan-de-cours -->
                    <button class="btn btn-sm btn-secondary w-100 fs-6" 
                            onclick="openPlanCoursModal('{{ c.id }}', '{{ c.code }}', '{{ c.nom }}')"
                            type="button">
                      Plan de cours
                    </button>
                  </div>

                </div>
              </div>
              {% endfor %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Ajouter un Nouveau Cours -->
  <a href="{{ url_for('main.add_cours') }}" class="btn btn-primary mb-4">Ajouter un Cours</a>
</div>

<!-- Styles personnalisés -->
<style>
  .card-link {
    display: block;
    height: 100%;
    color: inherit;
  }
  .card-link:hover {
    text-decoration: none;
  }

  .card {
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    height: 100%;
    transition: transform 0.2s;
    padding: 0;
  }
  .card:hover {
    transform: scale(1.02);
  }
  .card-header {
    font-size: 0.9rem;
    padding: 0.4rem;
    text-align: center;
    white-space: normal;
  }
  .card-body {
    padding: 0.4rem;
    font-size: 0.75rem;
  }
  .card-body p {
    margin-bottom: 0.2rem;
  }
  .card-footer {
    background-color: #f8f9fa;
    padding: 0.4rem;
  }
  .small.text-muted {
    font-size: 0.8rem;
  }
  .list-inline {
    margin: 0;
    padding: 0;
    list-style: none;
  }
  .list-inline-item {
    display: inline-block;
    margin-right: 0.5rem;
  }
</style>
<div class="modal fade" id="planCoursModal" tabindex="-1" aria-labelledby="planCoursModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="planCoursModalLabel">Gestion du plan de cours</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="modalCoursId">
        
        <div class="mb-3">
          <label class="form-label">Action désirée</label>
          <select class="form-select" id="actionSelect" onchange="updateFormFields()">
            <option value="">Choisir une action</option>
            <option value="create">Créer un nouveau plan de cours</option>
            <option value="modify" class="existing-plans-option">Modifier un plan existant</option>
            <option value="copy" class="existing-plans-option">Créer à partir d'un plan existant</option>
          </select>
        </div>

        <div class="mb-3 d-none" id="existingPlanSection">
          <label class="form-label">Plan de cours existant</label>
          <select class="form-select" id="existingPlanSelect">
          </select>
        </div>

        <div class="mb-3 d-none" id="sessionSection">
          <label class="form-label">Session</label>
          <select class="form-select" id="sessionSelect">
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" onclick="handlePlanCoursAction()">Confirmer</button>
      </div>
    </div>
  </div>
</div>

<script>
let planCoursModal;
let currentPlans = [];

document.addEventListener('DOMContentLoaded', function() {
    planCoursModal = new bootstrap.Modal(document.getElementById('planCoursModal'));
});

async function openPlanCoursModal(coursId, coursCode, coursNom) {
    document.getElementById('modalCoursId').value = coursId;
    document.getElementById('planCoursModalLabel').textContent = `Gestion des plan de cours - ${coursCode} ${coursNom}`;
    
    // Réinitialiser le formulaire
    document.getElementById('actionSelect').value = '';
    document.getElementById('existingPlanSection').classList.add('d-none');
    document.getElementById('sessionSection').classList.add('d-none');
    
    // Récupérer les plans existants
    try {
        const response = await fetch(`/api/cours/${coursId}/plans`);
        currentPlans = await response.json();
        
        // Mettre à jour l'interface selon l'existence de plans
        const existingPlansOptions = document.querySelectorAll('.existing-plans-option');
        existingPlansOptions.forEach(option => {
            option.style.display = currentPlans.length > 0 ? '' : 'none';
        });
        
        // Préparer le select des plans existants
        const existingPlanSelect = document.getElementById('existingPlanSelect');
        existingPlanSelect.innerHTML = currentPlans.map(plan => 
            `<option value="${plan.id}">Session ${plan.session}</option>`
        ).join('');
        
        // Préparer le select des sessions disponibles
        updateAvailableSessions();
        
    } catch (error) {
        console.error('Erreur lors de la récupération des plans:', error);
    }
    
    planCoursModal.show();
}

function updateFormFields() {
    const action = document.getElementById('actionSelect').value;
    const existingPlanSection = document.getElementById('existingPlanSection');
    const sessionSection = document.getElementById('sessionSection');
    
    existingPlanSection.classList.add('d-none');
    sessionSection.classList.add('d-none');
    
    if (action === 'modify') {
        existingPlanSection.classList.remove('d-none');
    } else if (action === 'create') {
        sessionSection.classList.remove('d-none');
    } else if (action === 'copy') {
        existingPlanSection.classList.remove('d-none');
        sessionSection.classList.remove('d-none');
    }
}

function updateAvailableSessions() {
    const currentYear = new Date().getFullYear() % 100;
    const nextYear = (currentYear + 1) % 100;
    
    const possibleSessions = [
        `A${currentYear}`,
        `H${nextYear}`,
        `E${nextYear}`
    ];
    
    // Filtrer les sessions déjà utilisées
    const availableSessions = possibleSessions.filter(session => 
        !currentPlans.some(plan => plan.session === session)
    );
    
    const sessionSelect = document.getElementById('sessionSelect');
    sessionSelect.innerHTML = availableSessions.map(session => 
        `<option value="${session}">${session}</option>`
    ).join('');
}

function handlePlanCoursAction() {
    const coursId = document.getElementById('modalCoursId').value;
    const action = document.getElementById('actionSelect').value;
    const existingPlanId = document.getElementById('existingPlanSelect').value;
    const session = document.getElementById('sessionSelect').value;
    
    let url = '';
    
    if (action === 'modify') {
        // Récupérer la session du plan existant depuis currentPlans
        const selectedPlan = currentPlans.find(plan => plan.id === parseInt(existingPlanId));
        if (selectedPlan) {
            url = `/cours/${coursId}/plan_de_cours/${selectedPlan.session}`;
        }
    } else if (action === 'create') {
        url = `/cours/${coursId}/plan_de_cours/${session}`;
    } else if (action === 'copy') {
        url = `/cours/${coursId}/plan_de_cours/${session}?copy_from=${existingPlanId}`;
    }
    
    if (url) {
        window.location.href = url;
    }
}
</script>
{% endblock %}
