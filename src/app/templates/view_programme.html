{% extends 'index.html' %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/view_programme.css') }}">
{% endblock %}

{% block programmes_specific %}
<div class="container mt-4">
  <div class="vp-header mb-3">
    <div>
      <div class="vp-title">
        <h2 class="mb-1">{{ programme.nom }}</h2>
        <div class="d-flex align-items-center gap-2">
          <a href="{{ url_for('programme.view_competences_programme', programme_id=programme.id) }}" class="btn btn-sm btn-outline-info">
            <i class="fas fa-list-ul"></i> Voir les compétences
          </a>
          <a href="{{ url_for('programme.competence_logigramme', programme_id=programme.id) }}" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-graph-up"></i> Logigramme compétences
          </a>
          {% if current_user.role in ['admin', 'coordo'] %}
          <a href="{{ url_for('grille_bp.import_grille') }}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-file-import"></i> Importer une grille
          </a>
          <button class="btn btn-sm btn-outline-success" type="button" id="btn-ai-grille" title="Générer une grille (IA)">
            <i class="fas fa-wand-magic-sparkles"></i> Générer (IA)
          </button>
          {% endif %}
          <a href="{{ url_for('programme.export_programme_grille_pdf', programme_id=programme.id) }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-file-earmark-pdf"></i> Exporter PDF
          </a>
          <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#vp-fil-bar" aria-expanded="false" aria-controls="vp-fil-bar">
            <i class="bi bi-tags"></i> Fils
          </button>
        </div>
      </div>

      <div id="vp-fil-bar" class="collapse mt-2">
        <div class="vp-fil-list" role="list">
          {% for fil in fil_conducteurs %}
            {% set bg = fil.couleur or '#cccccc' %}
            <span class="vp-fil-dot" title="{{ fil.description }}" style="--dot: {{ bg }}"></span>
          {% else %}
            <span class="vp-empty">Aucun fil conducteur</span>
          {% endfor %}
          {% if current_user.role in ['admin', 'coordo'] %}
            <a href="{{ url_for('main.add_fil_conducteur') }}" class="btn btn-xs btn-primary ms-2">Ajouter</a>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="vp-stats">
      <div class="vp-stat vp-stat-theorie">
        <div class="label">Théorie</div>
        <div class="value">{{ total_heures_theorie }} h</div>
      </div>
      <div class="vp-stat vp-stat-pratique">
        <div class="label">Pratique</div>
        <div class="value">{{ total_heures_laboratoire }} h</div>
      </div>
      <div class="vp-stat vp-stat-maison">
        <div class="label">Travail maison</div>
        <div class="value">{{ total_heures_travail_maison }} h</div>
      </div>
      <div class="vp-stat vp-stat-unites">
        <div class="label">Unités</div>
        <div class="value">{{ "%.2f"|format(total_unites) }}</div>
      </div>
    </div>
  </div>

  <div class="vp-toolbar mb-3">
    <div class="filters">
      <div class="input-group input-group-sm" style="max-width: 260px;">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input id="vp-search" type="search" class="form-control" placeholder="Rechercher (code ou nom) — / pour chercher">
      </div>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-sm btn-outline-secondary" type="button" id="vp-expand-all" data-state="collapsed">
        <i class="bi bi-arrows-expand"></i> Tout déplier
      </button>
    </div>
  </div>

  <div class="accordion" id="sessionsAccordion">
    {% for session, cours_list in cours_par_session.items() %}
      <div class="accordion-item vp-session" id="session-{{ loop.index }}">
        <h2 class="accordion-header" id="heading-{{ loop.index }}">
          <button class="accordion-button collapsed vp-session-header" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}" aria-expanded="false" aria-controls="collapse-{{ loop.index }}">
            <span class="fw-semibold">Session {{ session }}</span>
          </button>
        </h2>
        <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ loop.index }}">
          <div class="accordion-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="small text-muted">Exporter tous les plans de cours</div>
              <a href="{{ url_for('plan_de_cours.export_session_plans', programme_id=programme.id, session=session) }}"
                 class="btn btn-sm btn-outline-primary"
                 title="Exporter tous les plans de cours de la session {{ session }}">
                <i class="fas fa-file-export"></i> Exporter
              </a>
            </div>
            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-6" data-session="{{ session }}">
              {% for c in cours_list %}
                {% set bgc = c.fil_conducteur.couleur if c.fil_conducteur else '#f2f2f2' %}
                {% set fil_id = c.fil_conducteur.id if c.fil_conducteur else '' %}
                <div class="col mb-3 vp-course" data-code="{{ c.code|lower }}" data-name="{{ c.nom|lower }}" data-fil="{{ fil_id }}">
                  <div class="vp-course-card" style="--fil: {{ bgc }};">
                    <div class="vp-course-head">
                      <span class="vp-color-dot" style="background-color: {{ bgc }};"></span>
                      <h6 class="vp-course-title mb-0">
                        <a href="{{ url_for('cours.view_cours', cours_id=c.id) }}" class="text-decoration-none" data-code="{{ c.code }}" data-nom="{{ c.nom }}">
                          <strong>{{ c.code }}</strong> — {{ c.nom }}
                        </a>
                      </h6>
                    </div>
                    <div class="vp-course-body">
                      <div class="vp-hours mb-2" title="Théorie‑Pratique‑Maison">
                        <span class="vp-hours-badge">{{ c.heures_theorie }}‑{{ c.heures_laboratoire }}‑{{ c.heures_travail_maison }} h</span>
                      </div>
                      <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#details-{{ c.id }}" aria-expanded="false" aria-controls="details-{{ c.id }}">
                        Détails
                      </button>
                      <div id="details-{{ c.id }}" class="collapse mt-2">
                        <div class="mb-2">
                          <div class="fw-semibold small mb-1">Compétences</div>
                          <div class="vp-badges">
                            {% if competencies_codes[c.id] %}
                              {% for code in competencies_codes[c.id] %}
                                <a href="{{ url_for('programme.view_competence_by_code', competence_code=code) }}" class="badge rounded-pill bg-primary">{{ code }}</a>
                              {% endfor %}
                            {% else %}
                              <span class="vp-empty">Aucune</span>
                            {% endif %}
                          </div>
                        </div>
                        <div class="mb-2">
                          <div class="fw-semibold small mb-1">Prérequis</div>
                          <div>
                            {% if prerequisites[c.id] %}
                              {% for prereq, note in prerequisites[c.id] %}
                                <span class="d-block">{{ prereq }} ({{ note }}%)</span>
                              {% endfor %}
                            {% else %}
                              <span class="vp-empty">Aucun</span>
                            {% endif %}
                          </div>
                        </div>
                        <div>
                          <div class="fw-semibold small mb-1">Co‑requis</div>
                          <div>
                            {% if corequisites[c.id] %}
                              {{ corequisites[c.id]|join(', ') }}
                            {% else %}
                              <span class="vp-empty">Aucun</span>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="vp-course-actions text-center">
                      <a href="{{ url_for('cours.view_or_add_plan_cadre', cours_id=c.id) }}" class="btn btn-sm btn-info w-100 mb-2">
                        Plan‑Cadre
                      </a>
                      <button class="btn btn-sm btn-secondary w-100 plan-cours-btn"
                              data-id="{{ c.id }}"
                              data-code="{{ c.code }}"
                              data-nom="{{ c.nom|e }}"
                              type="button">
                        Plan de cours
                      </button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

{% if current_user.role in ['admin', 'coordo'] %}
  <a href="{{ url_for('main.add_cours') }}" class="btn btn-primary mb-4">Ajouter un Cours</a>
{% endif %}

</div>

<!-- Styles spécifiques déplacés dans static/css/view_programme.css -->

<!-- Modal Gestion du Plan de Cours -->
<div class="modal fade" id="planCoursModal" tabindex="-1" aria-labelledby="planCoursModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="planCoursModalLabel">Gestion du plan de cours</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="modalCoursId">
        
        <!-- Étape 1 : Choix de l'action -->
        <div class="mb-4" id="step1">
          <h6 class="mb-3">Choisissez une action :</h6>
          <div class="row g-3">
            <div class="col-md-4" id="action-create">
              <div class="card h-100 text-center p-3 action-card" data-action="create">
                <i class="fas fa-plus-circle fa-3x mb-3 text-primary"></i>
                <h6>Créer un nouveau plan de cours</h6>
              </div>
            </div>
            <div class="col-md-4" id="action-modify">
              <div class="card h-100 text-center p-3 action-card" data-action="modify">
                <i class="fas fa-edit fa-3x mb-3 text-warning"></i>
                <h6>Modifier un plan existant</h6>
              </div>
            </div>
            <div class="col-md-4" id="action-copy">
              <div class="card h-100 text-center p-3 action-card" data-action="copy">
                <i class="fas fa-copy fa-3x mb-3 text-success"></i>
                <h6>Créer à partir d'un plan existant</h6>
              </div>
            </div>
          </div>
        </div>

        <!-- Étape 2 : Sélection du plan existant (si nécessaire) -->
        <div class="mb-4 d-none" id="step2">
          <h6 class="mb-3">Sélectionnez un plan de cours existant :</h6>
          <div class="row g-3" id="existingPlansContainer">
            <!-- Les plans existants seront injectés ici -->
          </div>
        </div>

        <!-- Étape 3 : Sélection de la session (si nécessaire) -->
        <div class="mb-4 d-none" id="step3">
          <h6 class="mb-3">Sélectionnez une session :</h6>
          <div class="row g-3" id="sessionsContainer">
            <!-- Les sessions disponibles seront injectées ici -->
          </div>
        </div>

        <!-- Visualisation du flux -->
        <div class="mb-4 d-none" id="flowVisualization">
          <div class="d-flex align-items-center justify-content-center">
            <div id="sourcePlan" class="text-center p-3 bg-light rounded"></div>
            <div class="mx-3"><i class="fas fa-arrow-right fa-2x"></i></div>
            <div id="targetPlan" class="text-center p-3 bg-light rounded"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary d-none" id="confirmButton" onclick="handlePlanCoursAction()">Confirmer</button>
      </div>
    </div>
  </div>
</div>

<style>
  .action-card { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
  .action-card:hover { transform: translateY(-5px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  .action-card.selected { border: 2px solid #0d6efd; }
  #flowVisualization { background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; }
  .plan-card, .session-card { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
  .plan-card:hover, .session-card:hover { transform: translateY(-5px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  .plan-card.selected, .session-card.selected { border: 2px solid #0d6efd; }
</style>

<script>
const allCoursPlans = {{ cours_plans_mapping|tojson }};
let planCoursModal;
let currentPlans = [];
let selectedAction = '';
let selectedPlanId = '';
let selectedSession = '';

document.addEventListener('DOMContentLoaded', function() {
    // Initialisation du modal Bootstrap
    planCoursModal = new bootstrap.Modal(document.getElementById('planCoursModal'));
    
    // Gestion des clics sur les boutons Plan de cours
    document.querySelectorAll('.plan-cours-btn').forEach(button => {
        button.addEventListener('click', function() {
            const coursId = this.dataset.id;
            const coursCode = this.dataset.code;
            const coursNom = this.dataset.nom; // Utilisation directe sans JSON.parse

            openPlanCoursModal(coursId, coursCode, coursNom);
        });
    });
    
    // Gestion des clics sur les cartes d'action
    document.querySelectorAll('.action-card').forEach(card => {
        card.addEventListener('click', function() {
            selectedAction = this.dataset.action;
            document.querySelectorAll('.action-card').forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            showNextStep();
        });
    });
    
    // Utilisation de l'écouteur d'événements avec la délégation pour les éléments dynamiques
    document.getElementById('existingPlansContainer').addEventListener('click', function(event) {
        const planCard = event.target.closest('.plan-card');
        if (planCard) {
            const planId = planCard.dataset.planId;
            const session = planCard.dataset.session;
            selectPlan(planId, session);
        }
    });

    document.getElementById('sessionsContainer').addEventListener('click', function(event) {
        const sessionCard = event.target.closest('.session-card');
        if (sessionCard) {
            const session = sessionCard.dataset.session;
            selectSession(session);
        }
    });
    
    // Filtres simples (recherche seulement)
    const searchInput = document.getElementById('vp-search');
    const applyFilters = () => {
      const q = (searchInput.value || '').trim().toLowerCase();
      let firstMatch;

      // Reset previous highlights
      document.querySelectorAll('.vp-course-title a').forEach(a => {
        a.innerHTML = `<strong>${a.dataset.code}</strong> — ${a.dataset.nom}`;
      });

      // Filter courses and track matches per session
      document.querySelectorAll('.accordion-item.vp-session').forEach(sessionItem => {
        const collapseEl = sessionItem.querySelector('.accordion-collapse');
        const rows = sessionItem.querySelectorAll('.vp-course');
        let matchesInSession = 0;
        rows.forEach(node => {
          const code = node.dataset.code;
          const name = node.dataset.name;
          const matches = !q || code.includes(q) || name.includes(q);
          node.style.display = matches ? '' : 'none';
          if (matches) {
            matchesInSession++;
            if (!firstMatch) firstMatch = node;
            // Highlight
            const a = node.querySelector('.vp-course-title a');
            if (q && a) {
              const rawCode = a.dataset.code;
              const rawNom = a.dataset.nom;
              const safe = (t)=>t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
              const hl = (t)=>t.replace(new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'gi'), m=>`<mark>${m}</mark>`);
              a.innerHTML = `<strong>${hl(safe(rawCode))}</strong> — ${hl(safe(rawNom))}`;
            }
          }
        });
        // Expand sessions with matches; collapse others
        const bs = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
        if (q) {
          if (matchesInSession > 0 && !collapseEl.classList.contains('show')) bs.show();
          if (matchesInSession === 0 && collapseEl.classList.contains('show')) bs.hide();
        }
      });

      // Scroll to first match on new non-empty query
      if (q && firstMatch) {
        firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    };
    if (searchInput) {
      searchInput.addEventListener('input', applyFilters);
      // Keyboard shortcut to focus search
      window.addEventListener('keydown', (e) => {
        if (e.key === '/' && !e.target.matches('input, textarea')) {
          e.preventDefault();
          searchInput.focus();
        }
      });
    }

    // Déplier/Replier tous les détails visibles
    const expandBtn = document.getElementById('vp-expand-all');
    if (expandBtn) {
      expandBtn.addEventListener('click', () => {
        const state = expandBtn.getAttribute('data-state');
        const sessionCollapses = document.querySelectorAll('.accordion-collapse');
        if (state === 'collapsed') {
          // Open all sessions
          sessionCollapses.forEach(s => bootstrap.Collapse.getOrCreateInstance(s, { toggle: false }).show());
          // Open all details within
          document.querySelectorAll('.accordion-collapse .vp-course').forEach(card => {
            if (card.style.display === 'none') return;
            const detail = card.querySelector('.collapse');
            if (detail && !detail.classList.contains('show')) bootstrap.Collapse.getOrCreateInstance(detail, { toggle: false }).show();
          });
          expandBtn.setAttribute('data-state', 'expanded');
          expandBtn.innerHTML = '<i class="bi bi-arrows-collapse"></i> Tout replier';
        } else {
          // Close all details
          document.querySelectorAll('.accordion-collapse .collapse.show').forEach(d => bootstrap.Collapse.getOrCreateInstance(d, { toggle: false }).hide());
          // Close all sessions
          sessionCollapses.forEach(s => bootstrap.Collapse.getOrCreateInstance(s, { toggle: false }).hide());
          expandBtn.setAttribute('data-state', 'collapsed');
          expandBtn.innerHTML = '<i class="bi bi-arrows-expand"></i> Tout déplier';
        }
      });
    }

    // Desktop: expand all sessions by default (details remain collapsed)
    if (window.matchMedia('(min-width: 992px)').matches) {
      document.querySelectorAll('.accordion-collapse').forEach(s => {
        bootstrap.Collapse.getOrCreateInstance(s, { toggle: false }).show();
      });
    }

  });

async function openPlanCoursModal(coursId, coursCode, coursNom) {
    document.getElementById('modalCoursId').value = coursId;
    document.getElementById('planCoursModalLabel').textContent = `Gestion des plans de cours - ${coursCode} ${coursNom}`;
    
    // Réinitialiser le modal
    resetModal();
    
    // Récupérer les plans existants
    try {
        currentPlans = allCoursPlans[coursId] || [];
        
        // Afficher ou masquer les options en fonction des plans existants
        if (currentPlans.length === 0) {
            // Masquer 'Modifier' et 'Créer à partir d\'un plan existant'
            document.getElementById('action-modify').style.display = 'none';
            document.getElementById('action-copy').style.display = 'none';
        } else {
            // Afficher toutes les options
            document.getElementById('action-modify').style.display = 'block';
            document.getElementById('action-copy').style.display = 'block';
        }
        
    } catch (error) {
        console.error('Erreur lors de la récupération des plans:', error);
        alert('Impossible de récupérer les plans de cours existants.');
    }
    
    planCoursModal.show();
}

function resetModal() {
    selectedAction = '';
    selectedPlanId = '';
    selectedSession = '';
    
    document.getElementById('step1').classList.remove('d-none');
    document.getElementById('step2').classList.add('d-none');
    document.getElementById('step3').classList.add('d-none');
    document.getElementById('flowVisualization').classList.add('d-none');
    document.getElementById('confirmButton').classList.add('d-none');
    
    // Supprimer la sélection des cartes d'action
    document.querySelectorAll('.action-card').forEach(c => c.classList.remove('selected'));
}

function showNextStep() {
    if (selectedAction === '') {
        document.getElementById('step1').classList.remove('d-none');
        document.getElementById('step2').classList.add('d-none');
        document.getElementById('step3').classList.add('d-none');
        document.getElementById('flowVisualization').classList.add('d-none');
        document.getElementById('confirmButton').classList.add('d-none');
    } else if (selectedAction === 'modify' || selectedAction === 'copy') {
        document.getElementById('step1').classList.add('d-none');
        document.getElementById('step2').classList.remove('d-none');
        document.getElementById('step3').classList.add('d-none');
        document.getElementById('flowVisualization').classList.add('d-none');
        document.getElementById('confirmButton').classList.add('d-none');
        
        // Afficher les plans existants
        const container = document.getElementById('existingPlansContainer');
        if (currentPlans.length === 0) {
            container.innerHTML = '<p class="text-muted">Aucun plan de cours existant.</p>';
        } else {
          container.innerHTML = currentPlans.map(plan => {
              const modifiedDate = plan.session; // La session est déjà formatée
              const modifiedTimestamp = plan.modified_at
                  // Choisissez le format qui vous convient (toLocaleString(), toLocaleDateString(), etc.)
                  ? new Date(plan.modified_at).toLocaleDateString('fr-CA', { 
                        year: 'numeric', month: '2-digit', day: '2-digit'
                    })
                  : 'Non modifié';

              // On accède à plan.modified_by.username (pas plan.modified_by directement)
              const modifiedBy = (plan.modified_by && plan.modified_by.username)
                  ? `par ${plan.modified_by.username}`
                  : '';

              
              return `
                  <div class="col-md-4">
                      <div class="card h-100 text-center p-3 plan-card" data-plan-id="${plan.id}" data-session="${plan.session}">
                          <h6>Session ${plan.session}</h6>
                          <small class="text-muted">
                              Dernière modification:<br>
                              ${modifiedTimestamp} ${modifiedBy}
                          </small>
                      </div>
                  </div>
              `;
          }).join('');
        }
    } else if (selectedAction === 'create') {
        document.getElementById('step1').classList.add('d-none');
        document.getElementById('step2').classList.add('d-none');
        document.getElementById('step3').classList.remove('d-none');
        document.getElementById('flowVisualization').classList.add('d-none');
        document.getElementById('confirmButton').classList.remove('d-none');
        
        // Afficher les sessions disponibles
        updateAvailableSessions();
    }
}

function selectPlan(planId, session) {
    selectedPlanId = planId;
    document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected'));
    const selectedCard = document.querySelector(`.plan-card[data-plan-id="${planId}"]`);
    if (selectedCard) {
        selectedCard.classList.add('selected');
    }
    
    if (selectedAction === 'modify') {
            // Redirection immédiate vers le plan de cours
            const coursId = document.getElementById('modalCoursId').value;
            window.location.href = `/cours/${coursId}/plan_de_cours/${session}`;
    } else if (selectedAction === 'copy') {
        document.getElementById('step3').classList.remove('d-none');
        document.getElementById('flowVisualization').classList.remove('d-none');
        document.getElementById('sourcePlan').innerHTML = `
            <h6>Session ${session}</h6>
            <small class="text-muted">Plan source</small>
        `;
        updateAvailableSessions(true); // Indique une action de copie
    }
}

function selectSession(session) {
    selectedSession = session;
    document.querySelectorAll('.session-card').forEach(c => c.classList.remove('selected'));
    const selectedCard = document.querySelector(`.session-card[data-session="${session}"]`);
    if (selectedCard) {
        selectedCard.classList.add('selected');
    }
    
    document.getElementById('targetPlan').innerHTML = `
        <h6>Session ${session}</h6>
        <small class="text-muted">Nouveau plan</small>
    `;
    document.getElementById('confirmButton').classList.remove('d-none');
}

function updateAvailableSessions(isCopy = false) {
    const currentYear = new Date().getFullYear() % 100;
    const nextYear = (currentYear + 1) % 100;
    
    const possibleSessions = [
        `A${currentYear}`,
        `H${nextYear}`,
        `E${nextYear}`
    ];
    
    // Filtrer les sessions déjà utilisées
    const usedSessions = currentPlans.map(plan => plan.session);
    const availableSessions = possibleSessions.filter(session => 
        !usedSessions.includes(session)
    );
    
    const container = document.getElementById('sessionsContainer');
    if (availableSessions.length === 0) {
        container.innerHTML = '<p class="text-muted">Aucune session disponible.</p>';
    } else {
        container.innerHTML = availableSessions.map(session => `
            <div class="col-md-4">
              <div class="card h-100 text-center p-3 session-card" data-session="${session}">
                <h6>Session ${session}</h6>
              </div>
            </div>
        `).join('');
    }
}

function handlePlanCoursAction() {
    const coursId = document.getElementById('modalCoursId').value;
    let url = '';
    
    if (selectedAction === 'modify') {
        const selectedPlan = currentPlans.find(plan => plan.id === parseInt(selectedPlanId));
        if (selectedPlan) {
            url = `/cours/${coursId}/plan_de_cours/${selectedPlan.session}`;
        }
    } else if (selectedAction === 'create') {
        if (!selectedSession) {
            alert('Veuillez sélectionner une session.');
            return;
        }
        url = `/cours/${coursId}/plan_de_cours/${selectedSession}`;
    } else if (selectedAction === 'copy') {
        if (!selectedSession) {
            alert('Veuillez sélectionner une session.');
            return;
        }
        url = `/cours/${coursId}/plan_de_cours/${selectedSession}?copy_from=${selectedPlanId}`;
    }
    
    if (url) {
        window.location.href = url;
    }
}
</script>

<!-- Modal Génération de Grille (IA) -->
<div class="modal fade" id="aiGrilleModal" tabindex="-1" aria-labelledby="aiGrilleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="aiGrilleModalLabel">Générer une grille de cours (IA)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-12">
            <label for="ai_model" class="form-label">Modèle</label>
            <select id="ai_model" class="form-select form-select-sm">
              {% if generate_form and generate_form.ai_model.choices %}
                {% for val, label in generate_form.ai_model.choices %}
                  <option value="{{ val }}" {% if generate_form.ai_model.data == val %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              {% else %}
                <option value="gpt-5">gpt-5</option>
              {% endif %}
            </select>
          </div>
          <div class="col-sm-6">
            <label for="total_hours" class="form-label">Heures totales</label>
            <input type="number" id="total_hours" class="form-control form-control-sm" min="1" step="1" placeholder="ex: 1800">
          </div>
          <div class="col-sm-6">
            <label for="total_units" class="form-label">Unités totales (optionnel)</label>
            <input type="number" id="total_units" class="form-control form-control-sm" min="0" step="0.01" placeholder="ex: 90" value="{{ '%.2f'|format(total_unites) }}">
          </div>
          <div class="col-sm-6">
            <label for="nb_sessions" class="form-label">Nombre de sessions</label>
            <input type="number" id="nb_sessions" class="form-control form-control-sm" min="1" step="1" value="4">
          </div>
          <div class="col-sm-6">
            <label for="ai_reasoning" class="form-label">Effort de raisonnement</label>
            {% if generate_form %}
              {{ generate_form.reasoning_effort(class="form-select form-select-sm", id="ai_reasoning") }}
            {% else %}
              <select id="ai_reasoning" class="form-select form-select-sm">
                <option value="minimal">Minimal</option>
                <option value="low">Faible</option>
                <option value="medium" selected>Moyen</option>
                <option value="high">Élevé</option>
              </select>
            {% endif %}
          </div>
          <div class="col-sm-6">
            <label for="ai_verbosity" class="form-label">Verbosité</label>
            {% if generate_form %}
              {{ generate_form.verbosity(class="form-select form-select-sm", id="ai_verbosity") }}
            {% else %}
              <select id="ai_verbosity" class="form-select form-select-sm">
                <option value="low">Faible</option>
                <option value="medium" selected>Moyenne</option>
                <option value="high">Élevée</option>
              </select>
            {% endif %}
          </div>
          <div class="col-12">
            <label class="form-label">Mode d'application</label>
            <div class="d-flex gap-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="apply_mode" id="mode_append" value="append" checked>
                <label class="form-check-label" for="mode_append">Ajouter aux cours existants</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="apply_mode" id="mode_overwrite" value="overwrite">
                <label class="form-check-label" for="mode_overwrite">Écraser la grille existante</label>
              </div>
            </div>
          </div>
          <div class="col-12">
            <label for="ai_additional" class="form-label">Informations complémentaires (optionnel)</label>
            <textarea id="ai_additional" class="form-control form-control-sm" rows="3" placeholder="Contexte, contraintes, profil des étudiants…"></textarea>
          </div>
        </div>

        <div id="ai-grille-progress" class="mt-3 small text-muted"></div>
        <div id="ai-grille-preview" class="mt-3"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        <button type="button" class="btn btn-outline-primary" id="btn-ai-generate">Générer</button>
        <button type="button" class="btn btn-primary d-none" id="btn-ai-apply">Appliquer la grille</button>
      </div>
    </div>
  </div>
  </div>

<script>
  let aiGrilleModal;
  let aiGrilleResult = null;

  document.addEventListener('DOMContentLoaded', function() {
    aiGrilleModal = new bootstrap.Modal(document.getElementById('aiGrilleModal'));
    const openBtn = document.getElementById('btn-ai-grille');
    if (openBtn) openBtn.addEventListener('click', () => {
      resetAiGrilleModal();
      aiGrilleModal.show();
    });

    document.getElementById('btn-ai-generate').addEventListener('click', startAiGrilleGeneration);
    document.getElementById('btn-ai-apply').addEventListener('click', applyAiGrille);
  });

  function resetAiGrilleModal() {
    aiGrilleResult = null;
    document.getElementById('ai-grille-progress').textContent = '';
    document.getElementById('ai-grille-preview').innerHTML = '';
    document.getElementById('btn-ai-apply').classList.add('d-none');
  }

  async function startAiGrilleGeneration() {
    const generateBtn = document.getElementById('btn-ai-generate');
    const originalBtnHtml = generateBtn.innerHTML;
    // Désactiver le bouton et afficher un spinner pendant l'attente
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Génération…';

    const ai_model = document.getElementById('ai_model').value;
    const total_hours = parseInt(document.getElementById('total_hours').value || '0', 10);
    const total_units = parseFloat(document.getElementById('total_units').value || '0');
    const nb_sessions = parseInt(document.getElementById('nb_sessions').value || '0', 10);
    const additional_info = document.getElementById('ai_additional').value || '';
    const reasoning_effort = (document.getElementById('ai_reasoning')?.value) || 'medium';
    const verbosity = (document.getElementById('ai_verbosity')?.value) || 'medium';
    if (!total_hours || !nb_sessions) {
      alert('Veuillez saisir les heures totales et le nombre de sessions.');
      // Réactiver le bouton si validation échoue
      generateBtn.disabled = false;
      generateBtn.innerHTML = originalBtnHtml;
      return;
    }
    setAiGrilleProgress('Préparation de la génération…');
    // Notifier via le système global (comme pour les plans-cadres)
    try { addNotification('Génération de la grille en cours…', 'in-progress'); } catch(e) {}
    try {
      const csrf = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
      const resp = await fetch(`{{ url_for('programme.generate_programme_grille', programme_id=programme.id) }}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
        body: JSON.stringify({ ai_model, total_hours, total_units, nb_sessions, additional_info, reasoning_effort, verbosity })
      });
      if (!resp.ok) {
        const err = await resp.json().catch(()=>({error:'Erreur serveur'}));
        throw new Error(err.error || 'Erreur lors du démarrage de la génération');
      }
      const { task_id } = await resp.json();
      await pollAiTask(task_id);
      // Réactiver le bouton après succès du polling (proposition prête)
      generateBtn.disabled = false;
      generateBtn.innerHTML = originalBtnHtml;
    } catch (e) {
      setAiGrilleProgress('Erreur: ' + e.message);
      try { addNotification('Erreur de génération: ' + e.message, 'error'); } catch(_) {}
      // Réactiver le bouton en cas d'erreur
      generateBtn.disabled = false;
      generateBtn.innerHTML = originalBtnHtml;
    }
  }

  async function pollAiTask(taskId) {
    setAiGrilleProgress('Génération en cours…');
    while (true) {
      const r = await fetch(`{{ url_for('programme.programme_task_status', task_id='__TASK__') }}`.replace('__TASK__', taskId));
      const j = await r.json();
      if (j.state === 'SUCCESS') {
        if (j.status === 'success' && j.result) {
          aiGrilleResult = j.result;
          renderAiGrillePreview(aiGrilleResult);
          setAiGrilleProgress('Proposition prête. Vérifiez et appliquez.');
          try { addNotification('Proposition de grille prête. Vérifiez et appliquez.', 'success'); } catch(_) {}
          document.getElementById('btn-ai-apply').classList.remove('d-none');
          return;
        } else {
          throw new Error(j.message || 'Échec de la génération');
        }
      } else if (j.state === 'FAILURE' || j.status === 'error') {
        throw new Error(j.message || 'Échec de la tâche');
      } else {
        // PROGRESS or PENDING
        if (j.message) setAiGrilleProgress(j.message);
        await new Promise(res => setTimeout(res, 1200));
      }
    }
  }

  function renderAiGrillePreview(data) {
    const wrap = document.getElementById('ai-grille-preview');
    const sessions = (data && data.sessions) || [];
    const fils = (data && data.fils_conducteurs) || [];
    if (!sessions.length && !fils.length) { wrap.innerHTML = '<div class="text-muted">Aucune donnée.</div>'; return; }
    let html = '';
    sessions.sort((a,b)=> (a.session||0)-(b.session||0));
    for (const s of sessions) {
      html += `<div class="mb-3"><h6 class="mb-2">Session ${s.session}</h6>`;
      html += '<ul class="list-group list-group-sm">';
      for (const c of (s.courses||[])) {
        const ht = c.heures_theorie||0, hl=c.heures_laboratoire||0, hm=c.heures_travail_maison||0;
        const pre = Array.isArray(c.prealables) ? c.prealables : (c.prerequis||[]);
        const co = Array.isArray(c.corequis) ? c.corequis : [];
        const preTxt = (pre && pre.length) ? `Préalables: ${pre.map(x=>String(x)).join(', ')}` : '';
        const coTxt = (co && co.length) ? `Co‑requis: ${co.map(x=>String(x)).join(', ')}` : '';
        const relines = [preTxt, coTxt].filter(Boolean).join(' — ');
        html += `<li class="list-group-item">`+
                `<div class="d-flex justify-content-between align-items-center">`+
                `<span>${(c.nom||'Cours').replace(/</g,'&lt;')}</span>`+
                `<span class="badge bg-secondary">${ht}-${hl}-${hm} h</span>`+
                `</div>`+
                `${relines ? `<div class="small text-muted mt-1">${relines.replace(/</g,'&lt;')}</div>` : ''}`+
                `</li>`;
      }
      html += '</ul></div>';
    }
    if (fils.length) {
      html += '<div class="mb-2 mt-3"><h6 class="mb-2">Fils conducteurs</h6>';
      html += '<div class="d-flex flex-wrap gap-2">';
      for (const f of fils) {
        const color = (typeof f.couleur === 'string' && /^#([0-9a-fA-F]{6})$/.test(f.couleur)) ? f.couleur : '#888888';
        const desc = (f.description||'').replace(/</g,'&lt;');
        const assoc = (Array.isArray(f.cours) ? f.cours : (f.cours?[String(f.cours)]:[])).map(x=>String(x).replace(/</g,'&lt;'));
        html += `<div class="border rounded p-2" style="border-left:6px solid ${color};">
                    <div class="fw-semibold" style="color:${color}">${desc}</div>
                    ${assoc.length? `<div class="small text-muted">${assoc.join(', ')}</div>` : ''}
                  </div>`;
      }
      html += '</div></div>';
    }
    wrap.innerHTML = html;
  }

  function setAiGrilleProgress(msg) {
    document.getElementById('ai-grille-progress').textContent = msg || '';
  }

  async function applyAiGrille() {
    if (!aiGrilleResult) return;
    const mode = document.querySelector('input[name="apply_mode"]:checked')?.value || 'append';
    setAiGrilleProgress('Application en base…');
    try {
      const csrf = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
      const resp = await fetch(`{{ url_for('programme.apply_programme_grille', programme_id=programme.id) }}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
        body: JSON.stringify({ mode, grid: aiGrilleResult })
      });
      const j = await resp.json();
      if (!resp.ok || !j.ok) throw new Error(j.error || 'Échec application');
      setAiGrilleProgress('Grille appliquée. Rechargement…');
      window.location.reload();
    } catch (e) {
      setAiGrilleProgress('Erreur: ' + e.message);
    }
  }
</script>

{% endblock %}
