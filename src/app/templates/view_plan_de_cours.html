{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h1>Plan de cours</h1>
    <hr>

    <!-- Export Button - Aligned Right -->
    <div class="d-flex justify-content-start gap-2 mb-4">
        <a href="{{ url_for('plan_de_cours.export_docx', cours_id=cours.id, session=plan_de_cours.session) }}" 
           class="btn btn-success d-flex align-items-center">
            <i class="bi bi-file-earmark-word me-2"></i>
            <span>Exporter en .docx</span>
        </a>
        <button type="button" class="btn btn-outline-primary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#importDocxModal">
            <i class="bi bi-file-earmark-arrow-up me-2"></i>
            <span>Importer .docx</span>
        </button>
        <!-- Démarrer (unifié) -->
        <div class="btn-group">
          <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            Démarrer (unifié)
          </button>
          <ul class="dropdown-menu">
            <li>
              <a class="dropdown-item" href="#"
                 data-task-start
                 data-url="/api/plan_de_cours/{{ plan_de_cours.id }}/generate"
                 data-title="Générer le plan de cours"
                 data-mode="json"
                 data-json='{"prompt":""}'>Générer (API)</a>
            </li>
            <li>
              <a class="dropdown-item" href="#"
                 data-task-start
                 data-url="{{ url_for('plan_de_cours.import_docx_start') }}"
                 data-title="Importer Plan de cours (.docx)"
                 data-mode="form">Importer DOCX</a>
            </li>
          </ul>
        </div>
    </div>

    <div class="accordion" id="accordionPlanCours">
        <!-- Accordéon : Informations Générales sur le Cours -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingInfoGen">
                <button class="accordion-button collapsed bg-primary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInfoGen" aria-expanded="false" aria-controls="collapseInfoGen">
                    Informations générales sur le cours
                </button>
            </h2>
            <div id="collapseInfoGen" class="accordion-collapse collapse" aria-labelledby="headingInfoGen">
                <div class="accordion-body">
                    <p><strong>Code du cours :</strong> {{ cours.code }}</p>
                    <p><strong>Nom du cours :</strong> {{ cours.nom }}</p>
                    <p><strong>Nombre d'unités :</strong> {{ cours.nombre_unites | round(2) }}</p>
                    <p><strong>Heures Théorie :</strong> {{ cours.heures_theorie }}</p>
                    <p><strong>Heures Laboratoire :</strong> {{ cours.heures_laboratoire }}</p>
                    <p><strong>Heures Travail Maison :</strong> {{ cours.heures_travail_maison }}</p>
                    <p><strong>Nom du programme :</strong> 
                        {% if cours.programme %}
                            {{ cours.programme.nom }}
                        {% else %}
                            Non défini
                        {% endif %}
                    </p>
                    <p><strong>Nom du département :</strong> 
                        {% if departement %}
                            {{ departement.nom }}
                        {% else %}
                            Non défini
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- Accordéon : Informations PlanCadre -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingPlanCadre">
                <button class="accordion-button collapsed bg-secondary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePlanCadre" aria-expanded="false" aria-controls="collapsePlanCadre">
                    Capacités du cours
                </button>
            </h2>
            <div id="collapsePlanCadre" class="accordion-collapse collapse" aria-labelledby="headingPlanCadre">
                <div class="accordion-body">
                    <p><strong>Place et rôle du cours dans le programme :</strong></p>
                    <div class="bg-light p-2 mb-3">
                        {{ plan_cadre.place_intro | safe }}
                    </div>

                    <hr>

                    <h5>Capacités (incluant savoirs, savoir-faire)</h5>
                    {% if plan_cadre.capacites %}
                        <ul class="list-group mb-3">
                            {% for cap in plan_cadre.capacites %}
                                <li class="list-group-item">
                                    <h5 class="mb-1">Capacité : {{ cap.capacite }}</h5>
                                    {% if cap.description_capacite %}
                                        <p class="mb-1">{{ cap.description_capacite }}</p>
                                    {% endif %}
                                    <p class="mb-1">
                                        <strong>Pondération min/max :</strong> {{ cap.ponderation_min }} / {{ cap.ponderation_max }}
                                    </p>
                                    {% if cap.savoirs_necessaires %}
                                        <p><strong>Savoirs nécessaires :</strong></p>
                                        <ul>
                                            {% for sn in cap.savoirs_necessaires %}
                                                <li>{{ sn.texte }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p>Aucun savoir nécessaire défini.</p>
                                    {% endif %}
                                    {% if cap.savoirs_faire %}
                                        <p><strong>Savoir-faire :</strong></p>
                                        <ul>
                                            {% for sf in cap.savoirs_faire %}
                                                <li>
                                                    {{ sf.texte }}
                                                    {% if sf.cible %}  
                                                      &nbsp; — <em>Cible:</em> {{ sf.cible }}
                                                    {% endif %}
                                                    {% if sf.seuil_reussite %}
                                                      &nbsp; — <em>Seuil de réussite:</em> {{ sf.seuil_reussite }}
                                                    {% endif %}
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p>Aucun savoir-faire défini.</p>
                                    {% endif %}
                                    {% if cap.moyens_evaluation %}
                                        <p><strong>Moyens d'évaluation :</strong></p>
                                        <ul>
                                            {% for me in cap.moyens_evaluation %}
                                                <li>{{ me.texte }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p>Aucun moyen d'évaluation défini.</p>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Aucune capacité définie.</p>
                    {% endif %}

                    <hr>

                    <h5>Savoir-être</h5>
                    {% if plan_cadre.savoirs_etre %}
                        <ul class="list-group mb-3">
                            {% for se in plan_cadre.savoirs_etre %}
                                <li class="list-group-item">
                                    {{ se.texte }}
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Aucun savoir-être.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Accordéon : Règles Départementales -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingReglesDept">
                <button class="accordion-button collapsed bg-danger text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseReglesDept" aria-expanded="false" aria-controls="collapseReglesDept">
                    Règles départementales
                </button>
            </h2>
            <div id="collapseReglesDept" class="accordion-collapse collapse" aria-labelledby="headingReglesDept">
                <div class="accordion-body">
                    {% if regles_departementales %}
                        <ul class="list-group mb-3">
                            {% for regle in regles_departementales %}
                                <li class="list-group-item">
                                    <div class="fw-bold mb-2">{{ regle.regle }}</div>
                                    <div>{{ regle.contenu|markdown|safe }}</div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Aucune règle départementale définie.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Accordéon : Règles de PIEA -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingReglesPIEA">
                <button class="accordion-button collapsed bg-warning text-dark" type="button" data-bs-toggle="collapse" data-bs-target="#collapseReglesPIEA" aria-expanded="false" aria-controls="collapseReglesPIEA">
                    Règles de PIEA
                </button>
            </h2>
            <div id="collapseReglesPIEA" class="accordion-collapse collapse" aria-labelledby="headingReglesPIEA">
                <div class="accordion-body">
                    {% if regles_piea %}
                        <ul class="list-group mb-3">
                            {% for piea in regles_piea %}
                                <li class="list-group-item">
                                    <div class="fw-bold mb-2">{{ piea.article }}</div>
                                    <div>{{ piea.contenu|markdown|safe }}</div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Aucune règle de PIEA définie.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Accordéon : Édition du PlanDeCours -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingEdition">
                <button class="accordion-button collapsed bg-info text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEdition" aria-expanded="false" aria-controls="collapseEdition">
                    Contenu du cours
                </button>
            </h2>
            <div id="collapseEdition" class="accordion-collapse collapse" aria-labelledby="headingEdition">
                <div class="accordion-body">
                    <div class="d-flex justify-content-end mb-3">
                        <button type="button" class="btn btn-primary btn-sm" id="open-generate-plan-cours" title="Générer toutes les sections" data-bs-toggle="modal" data-bs-target="#generatePlanCoursModal">
                            <i class="bi bi-magic me-2"></i>Tout générer
                        </button>
                    </div>
                    <form method="POST" action="{{ url_for('plan_de_cours.view_plan_de_cours', cours_id=cours.id) }}" id="planDeCoursForm">
                        {{ form.hidden_tag() }}
                        <!-- Informations Principales -->
                        <h4>Informations Principales</h4>

                        <div class="mb-3 position-relative">
                            {{ form.campus.label(class="form-label fw-bold") }}
                            {{ form.campus(class="form-control") }}
                        </div>

                        <!-- Remplacer ce bloc dans le formulaire -->
                        <div class="mb-3 position-relative">
                            {{ form.session.label(class="form-label fw-bold") }}
                            <div class="form-control" style="background-color: #e9ecef;">{{ form.session.data }}</div>
                            {{ form.session(type="hidden") }}
                        </div>

                        <div class="mb-3 position-relative">
                            <div class="d-flex align-items-center justify-content-between">
                                <label for="presentation_du_cours" class="form-label fw-bold">Présentation du cours</label>
                                <button type="button" class="btn btn-secondary btn-sm generate-button" data-field="presentation_du_cours" title="Générer automatiquement">
                                    <i class="bi bi-magic"></i>Générer automatiquement
                                </button>
                            </div>
                            {{ form.presentation_du_cours(class="form-control auto-resize border-0", oninput="autoResize(this)", style="overflow:hidden; resize:none;", id="presentation_du_cours") }}
                        </div>

                        <div class="mb-3 position-relative">
                            <div class="d-flex align-items-center justify-content-between">
                                <label for="objectif_terminal_du_cours" class="form-label fw-bold">{{ form.objectif_terminal_du_cours.label.text }}</label>
                                <button type="button" class="btn btn-secondary btn-sm generate-button" data-field="objectif_terminal_du_cours" title="Générer automatiquement">
                                    <i class="bi bi-magic"></i>Générer automatiquement
                                </button>
                            </div>
                            {{ form.objectif_terminal_du_cours(class="form-control auto-resize border-0", oninput="autoResize(this)", style="overflow:hidden; resize:none;", id="objectif_terminal_du_cours") }}
                        </div>

                        <div class="mb-3 position-relative">
                            <div class="d-flex align-items-center justify-content-between">
                                <label for="organisation_et_methodes" class="form-label fw-bold">{{ form.organisation_et_methodes.label.text }}</label>
                                <button type="button" class="btn btn-secondary btn-sm generate-button" data-field="organisation_et_methodes" title="Générer automatiquement">
                                    <i class="bi bi-magic"></i>Générer automatiquement
                                </button>
                            </div>
                            {{ form.organisation_et_methodes(class="form-control auto-resize border-0", oninput="autoResize(this)", style="overflow:hidden; resize:none;", id="organisation_et_methodes") }}
                        </div>

                        <div class="mb-3 position-relative">
                            <div class="d-flex align-items-center justify-content-between">
                                <label for="accomodement" class="form-label fw-bold">{{ form.accomodement.label.text }}</label>
                                <button type="button" class="btn btn-secondary btn-sm generate-button" data-field="accomodement" title="Générer automatiquement">
                                    <i class="bi bi-magic"></i>Générer automatiquement
                                </button>
                            </div>
                            {{ form.accomodement(class="form-control auto-resize border-0", oninput="autoResize(this)", style="overflow:hidden; resize:none;", id="accomodement") }}
                        </div>

                        <div class="mb-3 position-relative">
                            <div class="d-flex align-items-center justify-content-between">
                                <label for="evaluation_formative_apprentissages" class="form-label fw-bold">{{ form.evaluation_formative_apprentissages.label.text }}</label>
                                <button type="button" class="btn btn-secondary btn-sm generate-button" data-field="evaluation_formative_apprentissages" title="Générer automatiquement">
                                    <i class="bi bi-magic"></i>Générer automatiquement
                                </button>
                            </div>
                            {{ form.evaluation_formative_apprentissages(class="form-control auto-resize border-0", oninput="autoResize(this)", style="overflow:hidden; resize:none;", id="evaluation_formative_apprentissages") }}
                        </div>

                        <div class="mb-3 position-relative">
                            <div class="d-flex align-items-center justify-content-between">
                                <label for="evaluation_expression_francais" class="form-label fw-bold">{{ form.evaluation_expression_francais.label.text }}</label>
                                <button type="button" class="btn btn-secondary btn-sm generate-button" data-field="evaluation_expression_francais" title="Générer automatiquement">
                                    <i class="bi bi-magic"></i>Générer automatiquement
                                </button>
                            </div>
                            {{ form.evaluation_expression_francais(class="form-control auto-resize border-0", oninput="autoResize(this)", style="overflow:hidden; resize:none;", id="evaluation_expression_francais") }}
                        </div>

                        <div class="mb-3">
                            {{ form.materiel.label(class="form-label fw-bold") }}
                            {{ form.materiel(
                                class="form-control auto-resize border-0",
                                oninput="autoResize(this)",
                                style="overflow:hidden; resize:none;") }}
                        </div>

                        <hr>
                        <h4>Informations sur l'enseignant</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.nom_enseignant.label(class="form-label fw-bold") }}
                                    {{ form.nom_enseignant(class="form-control") }}
                                </div>
                                <div class="mb-3">
                                    {{ form.telephone_enseignant.label(class="form-label fw-bold") }}
                                    {{ form.telephone_enseignant(class="form-control") }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.courriel_enseignant.label(class="form-label fw-bold") }}
                                    {{ form.courriel_enseignant(class="form-control") }}
                                </div>
                                <div class="mb-3">
                                    {{ form.bureau_enseignant.label(class="form-label fw-bold") }}
                                    {{ form.bureau_enseignant(class="form-control") }}
                                </div>
                            </div>
                        </div>

                        <!-- Calendrier -->
                        <div class="mb-3">
                            <div class="d-flex align-items-center justify-content-between">
                                <h4 class="mb-0">Calendrier des activités</h4>
                                <button type="button" class="btn btn-secondary btn-sm generate-calendar" id="generate-calendar" title="Générer le calendrier">
                                    <i class="bi bi-magic"></i>Générer le calendrier
                                </button>
                            </div>
                            <div id="calendrier-container" class="mb-3" {% if not form.calendriers %}style="display: none;"{% endif %}>
                                 {% for subform in form.calendriers %}
                                    <div class="calendar-item border p-2 mb-2 {% if loop.index0 is even %}bg-light{% else %}bg-secondary text-white{% endif %}" draggable="true">
                                        <div class="row align-items-end">
                                            <div class="col-auto pe-0">
                                                <div class="drag-handle" style="cursor: move; padding: 8px;">
                                                    <i class="bi bi-grip-vertical"></i>
                                                </div>
                                            </div>
                                            <div class="col">
                                                {{ subform.semaine.label(class="form-label") }}
                                                {{ subform.semaine(class="form-control") }}
                                            </div>
                                            <div class="col">
                                                {{ subform.sujet.label(class="form-label") }}
                                                {{ subform.sujet(class="form-control") }}
                                            </div>
                                            <div class="col">
                                                {{ subform.activites.label(class="form-label") }}
                                                {{ subform.activites(class="form-control") }}
                                            </div>
                                            <div class="col">
                                                {{ subform.travaux_hors_classe.label(class="form-label") }}
                                                {{ subform.travaux_hors_classe(class="form-control") }}
                                            </div>
                                            <div class="col">
                                                {{ subform.evaluations.label(class="form-label") }}
                                                {{ subform.evaluations(class="form-control") }}
                                            </div>
                                            <div class="col-auto">
                                                <button type="button" class="btn btn-danger btn-sm remove-calendar">
                                                    <i class="bi bi-dash-circle"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-success btn-sm" id="add-calendrier" title="Ajouter">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </div>
                        </div>


                        <!-- Médiagraphie -->
                        <div class="mb-3">
                            <h4>Médiagraphie</h4>
                            <div id="mediagraphie-container" class="mb-3" {% if not form.mediagraphies %}style="display: none;"{% endif %}>
                                {% for subform in form.mediagraphies %}
                                    <div class="mediagraphie-item mb-2">
                                        <div class="row align-items-end">
                                            <div class="col">
                                                {{ subform.reference_bibliographique.label(class="form-label") }}
                                                {{ subform.reference_bibliographique(class="form-control") }}
                                            </div>
                                            <div class="col-auto">
                                                <button type="button" class="btn btn-danger btn-sm remove-mediagraphie">
                                                    <i class="bi bi-dash-circle"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-success btn-sm" id="add-mediagraphie" title="Ajouter">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Disponibilités -->
                        <div class="mb-3">
                            <h4>Disponibilités de l'enseignant</h4>
                            <div id="disponibilites-container" class="mb-3" {% if not form.disponibilites %}style="display: none;"{% endif %}>
                                {% for subform in form.disponibilites %}
                                    <div class="disponibilite-item mb-2">
                                        <div class="row align-items-end">
                                            <div class="col">
                                                {{ subform.jour_semaine.label(class="form-label") }}
                                                {{ subform.jour_semaine(class="form-control") }}
                                            </div>
                                            <div class="col">
                                                {{ subform.plage_horaire.label(class="form-label") }}
                                                {{ subform.plage_horaire(class="form-control") }}
                                            </div>
                                            <div class="col">
                                                {{ subform.lieu.label(class="form-label") }}
                                                {{ subform.lieu(class="form-control") }}
                                            </div>
                                            <div class="col-auto">
                                                <button type="button" class="btn btn-danger btn-sm remove-disponibilite">
                                                    <i class="bi bi-dash-circle"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-success btn-sm" id="add-disponibilite" title="Ajouter">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Évaluations -->
                        <div class="mb-3">
                            <h4>Évaluations</h4>
                            <div id="evaluations-container" class="mb-3" {% if not form.evaluations %}style="display: none;"{% endif %}>
                                {% for evaluation_subform in form.evaluations %}
                                    <div class="card mb-3 evaluation-item {% if loop.index0 is even %}bg-light{% else %}bg-secondary text-white{% endif %}" data-eval-index="{{ loop.index0 }}">
                                        <input type="hidden" name="evaluations-{{ loop.index0 }}-id" value="{{ evaluation_subform.id.data if evaluation_subform.id else '' }}">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <strong>Évaluation {{ loop.index }}</strong>
                                            <button type="button" class="btn btn-danger btn-sm remove-evaluation" title="Supprimer l'évaluation">
                                                <i class="bi bi-dash-circle"></i>
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col">
                                                    {{ evaluation_subform.titre_evaluation.label(class="form-label") }}
                                                    {{ evaluation_subform.titre_evaluation(class="form-control") }}
                                                </div>
                                                <div class="col">
                                                    {{ evaluation_subform.semaine.label(class="form-label") }}
                                                    {{ evaluation_subform.semaine(class="form-control") }}
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                {{ evaluation_subform.texte_description.label(class="form-label") }}
                                                {{ evaluation_subform.texte_description(class="form-control") }}
                                            </div>
                                            <div class="capacites-section">
                                                <h5>Capacités évaluées</h5>
                                                <div class="capacites-container">
                                                    {% for cap_subform in evaluation_subform.capacites %}
                                                        <div class="capacite-item card bg-light mb-2 p-2">
                                                            <input type="hidden" name="evaluations-{{ loop.index0 }}-capacites-{{ loop.index0 }}-id" value="{{ cap_subform.id.data if cap_subform.id else '' }}">
                                                            <div class="row align-items-end">
                                                                <div class="col">
                                                                    {{ cap_subform.capacite_id.label(class="form-label") }}
                                                                    {{ cap_subform.capacite_id(class="form-control") }}
                                                                </div>
                                                                <div class="col">
                                                                    {{ cap_subform.ponderation.label(class="form-label") }}
                                                                    {{ cap_subform.ponderation(class="form-control") }}
                                                                </div>
                                                                <div class="col-auto">
                                                                    <button type="button" class="btn btn-danger btn-sm remove-capacite" title="Supprimer la capacité">
                                                                        <i class="bi bi-dash-circle"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                                <div class="d-flex justify-content-end mt-2">
                                                    <button type="button" class="btn btn-success btn-sm add-capacite" title="Ajouter une capacité">
                                                        <i class="bi bi-plus-circle"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-success btn-sm" id="add-evaluation" title="Ajouter une évaluation">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </div>
                        </div>

                        <button type="submit" id="floatingSaveBtn" class="btn d-none">
                            <i class="bi bi-check-lg"></i>
                        </button>
                        <button type="button" id="floatingCancelBtn" class="btn d-none">
                            <i class="bi bi-x-lg"></i>
                        </button>
                        <div class="mt-4">
                            <a href="{{ url_for('plan_de_cours.export_docx', cours_id=cours.id, session=plan_de_cours.session) }}" class="btn btn-success" role="button">
                                Exporter le Plan de Cours en .docx
                            </a>
                        </div>
                    </form>

                    <!-- Modal Import DOCX moved below to avoid collapse visibility issues -->

                    <!-- Modèles cachés pour clonage -->
<div id="calendrier-template" class="calendar-item border p-2 mb-2" draggable="true" style="display: none;">
    <div class="row align-items-end">
        <div class="col-auto pe-0">
            <div class="drag-handle" style="cursor: move; padding: 8px;">
                <i class="bi bi-grip-vertical"></i>
            </div>
        </div>
        <div class="col">
            <label class="form-label" for="calendriers-__index__-semaine">Semaine</label>
            <input type="text" name="calendriers-__index__-semaine" class="form-control" id="calendriers-__index__-semaine" />
        </div>
        <div class="col">
            <label class="form-label" for="calendriers-__index__-sujet">Sujet</label>
            <input type="text" name="calendriers-__index__-sujet" class="form-control" id="calendriers-__index__-sujet" />
        </div>
        <div class="col">
            <label class="form-label" for="calendriers-__index__-activites">Activités</label>
            <input type="text" name="calendriers-__index__-activites" class="form-control" id="calendriers-__index__-activites" />
        </div>
        <div class="col">
            <label class="form-label" for="calendriers-__index__-travaux_hors_classe">Travaux hors classe</label>
            <input type="text" name="calendriers-__index__-travaux_hors_classe" class="form-control" id="calendriers-__index__-travaux_hors_classe" />
        </div>
        <div class="col">
            <label class="form-label" for="calendriers-__index__-evaluations">Évaluations</label>
            <input type="text" name="calendriers-__index__-evaluations" class="form-control" id="calendriers-__index__-evaluations" />
        </div>
        <div class="col-auto">
            <button type="button" class="btn btn-danger btn-sm remove-calendar">
                <i class="bi bi-dash-circle"></i>
            </button>
        </div>
    </div>
</div>


                        <!-- Template Médiagraphie -->
                        <div id="mediagraphie-template" class="mediagraphie-item mb-2" style="display: none;">
                            <div class="row align-items-end">
                                <div class="col">
                                    <label class="form-label" for="mediagraphies-__index__-reference_bibliographique">Référence bibliographique</label>
                                    <input type="text" name="mediagraphies-__index__-reference_bibliographique" class="form-control" id="mediagraphies-__index__-reference_bibliographique" />
                                </div>
                                <div class="col-auto">
                                    <button type="button" class="btn btn-danger btn-sm remove-mediagraphie">
                                        <i class="bi bi-dash-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Template Disponibilité -->
                        <div id="disponibilite-template" class="disponibilite-item mb-2" style="display: none;">
                            <div class="row align-items-end">
                                <div class="col">
                                    <label class="form-label" for="disponibilites-__index__-jour_semaine">Jour</label>
                                    <input type="text" name="disponibilites-__index__-jour_semaine" class="form-control" id="disponibilites-__index__-jour_semaine" />
                                </div>
                                <div class="col">
                                    <label class="form-label" for="disponibilites-__index__-plage_horaire">Plage horaire</label>
                                    <input type="text" name="disponibilites-__index__-plage_horaire" class="form-control" id="disponibilites-__index__-plage_horaire" />
                                </div>
                                <div class="col">
                                    <label class="form-label" for="disponibilites-__index__-lieu">Lieu</label>
                                    <input type="text" name="disponibilites-__index__-lieu" class="form-control" id="disponibilites-__index__-lieu" />
                                </div>
                                <div class="col-auto">
                                    <button type="button" class="btn btn-danger btn-sm remove-disponibilite">
                                        <i class="bi bi-dash-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Template Évaluation -->
                        <div id="evaluation-template" class="evaluation-item border p-2 mb-2" style="display: none;">
                            <input type="hidden" name="evaluations-__index__-id" id="evaluations-__index__-id" value="">
                            <button type="button" class="btn btn-danger btn-sm float-end remove-evaluation">
                                <i class="bi bi-dash-circle"></i>
                            </button>
                            <div class="row mb-2">
                                <div class="col">
                                    <label class="form-label" for="evaluations-__index__-titre_evaluation">Titre</label>
                                    <input type="text" name="evaluations-__index__-titre_evaluation" class="form-control" id="evaluations-__index__-titre_evaluation" />
                                </div>
                                <div class="col">
                                    <label class="form-label" for="evaluations-__index__-semaine">Semaine</label>
                                    <input type="text" name="evaluations-__index__-semaine" class="form-control" id="evaluations-__index__-semaine" />
                                </div>
                            </div>
                            <div class="mb-2">
                                <label class="form-label" for="evaluations-__index__-texte_description">Description</label>
                                <textarea name="evaluations-__index__-texte_description" class="form-control" id="evaluations-__index__-texte_description"></textarea>
                            </div>
                            <h5>Capacités évaluées</h5>
                            <div class="capacites-container">
                            </div>
                            <div class="d-flex justify-content-end mb-2">
                                <button type="button" class="btn btn-success btn-sm add-capacite">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Template Capacité Évaluée -->
                        <div id="evaluation-capacite-template" class="capacite-item mb-2 border p-2" style="display: none;">
                                <input type="hidden" name="evaluations-__eval_index__-capacites-__cap_index__-id" 
           id="evaluations-__eval_index__-capacites-__cap_index__-id" value="">
                            <div class="row align-items-end">
                                <div class="col">
                                    <label class="form-label" for="evaluations-__eval_index__-capacites-__cap_index__-capacite_id">Capacité</label>
                                    <select class="form-control" name="evaluations-__eval_index__-capacites-__cap_index__-capacite_id" id="evaluations-__eval_index__-capacites-__cap_index__-capacite_id">
                                    </select>
                                </div>
                                <div class="col">
                                    <label class="form-label" for="evaluations-__eval_index__-capacites-__cap_index__-ponderation">Pondération</label>
                                    <input type="text" class="form-control" name="evaluations-__eval_index__-capacites-__cap_index__-ponderation" id="evaluations-__eval_index__-capacites-__cap_index__-ponderation">
                                </div>
                                <div class="col-auto">
                                    <button type="button" class="btn btn-danger btn-sm remove-capacite">
                                        <i class="bi bi-dash-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <select id="capacites-hidden" style="display: none;">
                        {% for cap in plan_cadre.capacites %}
                            <option value="{{ cap.id }}">{{ cap.capacite }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Toast UI Editor CSS -->
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.css" />

<!-- Toast UI Editor Scripts with defer -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<script src="https://uicdn.toast.com/editor-plugin-autoheight/latest/toastui-editor-plugin-autoheight.js"></script>

<style>
.calendar-item {
    cursor: move;
    transition: all 0.3s ease;
    background-color: white;
}

.calendar-item.dragging {
    opacity: 0.5;
    border: 2px dashed #666 !important;
    background-color: #f8f9fa;
}

.calendar-item.drag-over {
    border: 2px solid #0d6efd !important;
    transform: translateY(5px);
}

.drag-handle {
    color: #666;
    transition: color 0.2s;
    cursor: grab;
}

.drag-handle:hover {
    color: #0d6efd;
}

.drag-handle:active {
    cursor: grabbing;
}

    .calendar-item {
        transition: all 0.2s ease;
    }
    .evaluation-item {
        transition: all 0.3s ease;
    }
    .evaluation-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .remove-evaluation, .remove-capacite {
        opacity: 0.8;
    }
    .remove-evaluation:hover, .remove-capacite:hover {
        opacity: 1;
    }
    #floatingSaveBtn, #floatingCancelBtn {
        position: fixed;
        bottom: 20px;
        z-index: 1000;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    #floatingSaveBtn {
        right: 20px;
        background-color: #0d6efd;
        color: white;
    }
    #floatingCancelBtn {
        right: 90px;
        background-color: #dc3545;
        color: white;
    }
    #floatingSaveBtn .bi, #floatingCancelBtn .bi {
        font-size: 1.5rem;
    }
    #floatingSaveBtn.d-none, #floatingCancelBtn.d-none {
        display: none !important;
    }
    .spinner-border {
        display: none;
        width: 1.5rem;
        height: 1.5rem;
    }
    #floatingSaveBtn.loading .bi {
        display: none;
    }
    #floatingSaveBtn.loading .spinner-border {
        display: inline-block;
    }
/* Hide textarea until Toast UI loads */
textarea.toast-ui-target:not(.toast-initialized) {
    opacity: 0;
    height: 0;
    padding: 0 !important;
    margin: 0 !important;
    border: none !important;
}

/* Make the text in the editable area bigger */
.toastui-editor-contents {
    font-size: 1.1rem !important;
    line-height: 1.5 !important;
}

/* Toolbar button icon sizes */
.toastui-editor-defaultUI .toastui-editor-toolbar-icons {
    font-size: 1.25rem !important;
}

.toastui-editor-toolbar {
    transition: display 0.2s ease;
}

/* Regular input and textarea styles to match Toast UI */
.form-control {
    border: 1px solid #dee2e6 !important;
    border-radius: 0.375rem !important;
    padding: 0.5rem !important;
    margin-bottom: 1rem !important;
}

/* Focus styles */
.form-control:focus {
    border-color: #86b7fe !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
}
.generate-button {
    position: relative;
}

.generate-button.loading,
.generate-calendar.loading {
    pointer-events: none;
    opacity: 0.7;
}

#generate-all.loading {
    pointer-events: none;
    opacity: 0.7;
}

.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.loading-dots {
    display: flex;
    align-items: center;
    gap: 6px;
}

.loading-dots span {
    width: 8px;
    height: 8px;
    background-color: #0d6efd;
    border-radius: 50%;
    animation: bounce 0.5s alternate infinite;
}

.loading-dots span:nth-child(2) {
    animation-delay: 0.1s;
}

.loading-dots span:nth-child(3) {
    animation-delay: 0.2s;
}

@keyframes bounce {
    from {
        transform: translateY(0);
    }
    to {
        transform: translateY(-8px);
    }
}

.loading-text {
    margin-left: 12px;
    color: #0d6efd;
    font-size: 14px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Soumission du modal de génération globale du plan de cours
    const genForm = document.getElementById('generatePlanCoursForm');
    if (genForm) {
        genForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('confirmGeneratePlanCoursBtn');
            submitBtn?.classList.add('loading');
            submitBtn?.setAttribute('disabled', 'disabled');

            const csrfToken = "{{ csrf_token() }}";
            const formData = new FormData(genForm);
            // Démarrer la tâche asynchrone puis poller jusqu'à complétion
            const payload = new URLSearchParams();
            payload.append('cours_id', String({{ cours.id }}));
            payload.append('session', "{{ plan_de_cours.session }}");
            const addInfo = formData.get('additional_info');
            if (addInfo) payload.append('additional_info', addInfo);
            const aiModel = formData.get('ai_model');
            if (aiModel) payload.append('ai_model', aiModel);

            const statusText = document.createElement('div');
            statusText.className = 'small text-muted mb-2';
            statusText.id = 'generatePlanCoursStatus';
            statusText.textContent = 'Préparation de la génération...';
            genForm.querySelector('.modal-body')?.appendChild(statusText);

            try {
                // Démarrer via orchestrateur unifié + modal de suivi
                const params = new URLSearchParams();
                params.append('cours_id', String({{ cours.id }}));
                params.append('session', "{{ plan_de_cours.session }}");
                const addInfo = formData.get('additional_info');
                if (addInfo) params.append('additional_info', addInfo);
                const aiModel = formData.get('ai_model');
                if (aiModel) params.append('ai_model', aiModel);

                const startUrl = "{{ url_for('plan_de_cours.generate_all_start') }}";
                await window.EDxoTasks.startCeleryTask(startUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': csrfToken },
                    body: params.toString(),
                    credentials: 'same-origin'
                }, {
                    title: 'Génération du plan de cours',
                    startMessage: 'Génération en cours…',
                    onDone: (payload) => {
                        const reviewUrl = payload && payload.validation_url
                          ? payload.validation_url
                          : (`/plan_de_cours/review/${payload?.plan_id || ''}?task_id=${sessionStorage.getItem('currentTaskId')||''}`);
                        try { addNotification('Génération terminée. Cliquez pour comparer.', 'success', reviewUrl); } catch(_) {}
                    }
                });

                // Fermer le modal de configuration
                const modalEl = document.getElementById('generatePlanCoursModal');
                const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                modal.hide();
                statusText.remove();
            } catch (e) {
                console.error('Erreur génération complète du plan de cours', e);
                const toast = document.getElementById('generateErrorToast');
                if (toast) new bootstrap.Toast(toast).show();
            } finally {
                submitBtn?.classList.remove('loading');
                submitBtn?.removeAttribute('disabled');
            }
        });
    }
    // Fonction pour afficher les toasts
    function showToast(toastId) {
        const toastElement = document.getElementById(toastId);
        if (toastElement) {
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }
    }

    // Ajout des styles pour l'indicateur de chargement
    const style = document.createElement('style');
    style.textContent = `
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-dots {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .loading-dots span {
            width: 8px;
            height: 8px;
            background-color: #0d6efd;
            border-radius: 50%;
            animation: bounce 0.5s alternate infinite;
        }
        .loading-dots span:nth-child(2) { animation-delay: 0.1s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.2s; }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-8px); }
        }
        .loading-text {
            margin-left: 12px;
            color: #0d6efd;
            font-size: 14px;
        }
        .generate-button.loading {
            pointer-events: none;
            opacity: 0.7;
        }
    `;
    document.head.appendChild(style);

    // Gestion des clics sur les boutons de génération
    document.querySelectorAll('.generate-button').forEach(button => {
        button.addEventListener('click', async function() {
            const fieldName = this.getAttribute('data-field');
            const fieldElement = document.getElementById(fieldName);
            if (!fieldElement) {
                console.error(`Champ ${fieldName} non trouvé.`);
                showToast('generateErrorToast');
                return;
            }

            // Créer et ajouter l'overlay de chargement
            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'loading-overlay';
            loadingOverlay.innerHTML = `
                <div class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                    <div class="loading-text">Génération en cours...</div>
                </div>
            `;
            
            // Ajouter l'overlay et configurer le conteneur parent
            fieldElement.parentElement.style.position = 'relative';
            fieldElement.parentElement.appendChild(loadingOverlay);
            
            // Désactiver le bouton pendant la génération
            this.classList.add('loading');
            this.disabled = true;

            try {
                const payload = {
                    field_name: fieldName,
                    current_value: fieldElement.value || '',
                    cours_id: {{ cours.id }},
                    session: "{{ plan_de_cours.session }}"
                };

                const response = await fetch("{{ url_for('plan_de_cours.generate_content') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': "{{ csrf_token() }}"
                    },
                    body: JSON.stringify(payload),
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erreur inconnue lors de la génération.');
                }

                const data = await response.json();

                if (data.champ_description) {
                    fieldElement.value = data.champ_description;
                    if (fieldElement.toastEditor) {
                        fieldElement.toastEditor.setMarkdown(data.champ_description);
                    }
                    showToast('generateSuccessToast');
                } else {
                    throw new Error('Contenu généré non reçu.');
                }
            } catch (error) {
                console.error('Erreur lors de la génération automatique:', error);
                showToast('generateErrorToast');
            } finally {
                // Nettoyer : supprimer l'overlay et réactiver le bouton
                const overlay = fieldElement.parentElement.querySelector('.loading-overlay');
                if (overlay) {
                    overlay.remove();
                }
                this.classList.remove('loading');
                this.disabled = false;
            }
        });
    });
});
document.addEventListener('DOMContentLoaded', function() {
    const toastFields = [
        'presentation_du_cours',
        'objectif_terminal_du_cours', 
        'organisation_et_methodes',
        'accomodement',
        'evaluation_formative_apprentissages',
        'evaluation_expression_francais',
        'seuil_reussite',
        'materiel'
    ];

    toastFields.forEach(fieldId => {
        const textarea = document.getElementById(fieldId);

        if (textarea) {
            const container = document.createElement('div');
            textarea.parentNode.insertBefore(container, textarea);
            textarea.style.display = 'none';

            const editor = new toastui.Editor({
                el: container,
                initialEditType: 'wysiwyg',
                initialValue: textarea.value || '',
                toolbarItems: [
                    ['bold', 'italic'],
                    ['ul', 'indent', 'outdent']
                ],
                usageStatistics: false,
                hideModeSwitch: true,
                autofocus: false,
                height: 'auto',
                minHeight: '100px',
                toolbarVisibleWithoutEditor: false,
                customKeyMap: {
                    Tab: (editor, ev) => {
                        ev.preventDefault();
                        editor.exec('indent');
                    },
                    'Shift-Tab': (editor, ev) => {
                        ev.preventDefault();
                        editor.exec('outdent');
                    }
                }
            });

            textarea.classList.add('toast-initialized');
            textarea.toastEditor = editor;

            editor.on('change', () => {
                textarea.value = editor.getMarkdown();
                if (typeof window.showFloatingButtons === 'function') {
                    window.showFloatingButtons();
                }
            });
        } else {
            console.warn(`Le champ ${fieldId} n'existe pas !`);
        }
    });

    function waitForToastUI() {
        return new Promise((resolve) => {
            function checkToastUI() {
                if (window.toastui && window.toastui.Editor && toastui.Editor.plugin) {
                    resolve();
                } else {
                    setTimeout(checkToastUI, 100);
                }
            }
            checkToastUI();
        });
    }


    // Initialiser les éditeurs Toast UI
    async function initToastEditors() {
        await waitForToastUI();

        toastFields.forEach(fieldId => {
            const textarea = document.getElementById(fieldId);
            if (textarea) {
                try {
                    const container = document.createElement('div');
                    textarea.parentNode.insertBefore(container, textarea);
                    textarea.style.display = 'none';

                    const editor = new toastui.Editor({
                        el: container,
                        initialEditType: 'wysiwyg',
                        initialValue: textarea.value || '',
                        height: 'auto',
                        minHeight: '200px',
                        toolbarItems: [
                            ['heading', 'bold', 'italic', 'strike'],
                            ['ul', 'ol', 'indent', 'outdent'],
                            ['table', 'link']
                        ],
                        plugins: [toastui.Editor.plugin.autoHeight],
                        usageStatistics: false,
                        hideModeSwitch: true
                    });

                    // Gestionnaire de changement
                    editor.on('change', () => {
                        textarea.value = editor.getMarkdown();
                        if (typeof window.showFloatingButtons === 'function') {
                            window.showFloatingButtons();
                        }
                    });

                    // Marquer comme initialisé
                    textarea.classList.add('toast-initialized');
                    textarea.toastEditor = editor;

                } catch (error) {
                    console.error(`Erreur lors de l'initialisation de l'éditeur pour ${fieldId}:`, error);
                }
            }
        });
    }

    // Lancer l'initialisation
    initToastEditors();
});

document.addEventListener('DOMContentLoaded', function() {
    const planDeCoursForm = document.getElementById('planDeCoursForm');
    const floatingSaveBtn = document.getElementById('floatingSaveBtn');
    const floatingCancelBtn = document.getElementById('floatingCancelBtn');
    const calendrierContainer = document.getElementById('calendrier-container');

    let calendrierIndex = document.querySelectorAll('.calendar-item').length;
    let mediagraphieIndex = document.querySelectorAll('.mediagraphie-item').length;
    let disponibiliteIndex = document.querySelectorAll('.disponibilite-item').length;
    let evaluationIndex = document.querySelectorAll('.evaluation-item').length;
    let draggedItem = null;

    // Fonction globale pour afficher/cacher les boutons flottants
    window.showFloatingButtons = function() {
        if (floatingSaveBtn && floatingCancelBtn) {
            floatingSaveBtn.classList.remove('d-none');
            floatingCancelBtn.classList.remove('d-none');
        }
    };

    // Fonction pour réindexer les éléments du calendrier
    function reindexCalendrier() {
        const items = calendrierContainer.querySelectorAll('.calendar-item');
        items.forEach((item, index) => {
            item.querySelectorAll('[name]').forEach(input => {
                input.name = input.name.replace(/calendriers-\d+-/, `calendriers-${index}-`);
                input.id = input.id.replace(/calendriers-\d+-/, `calendriers-${index}-`);
            });
            item.querySelectorAll('label').forEach(label => {
                const forAttr = label.getAttribute('for');
                if (forAttr) {
                    label.setAttribute('for', forAttr.replace(/calendriers-\d+-/, `calendriers-${index}-`));
                }
            });
        });
        window.showFloatingButtons();
    }

    // Fonction de réindexation des évaluations
    function reindexEvaluations() {
        const evaluations = document.querySelectorAll('.evaluation-item');
        evaluations.forEach((evaluation, evalIndex) => {
            // Preserve the evaluation ID if it exists
            const evaluationId = evaluation.getAttribute('data-evaluation-id');
            if (evaluationId) {
                const idInput = evaluation.querySelector(`input[name^="evaluations-"][name$="-id"]`);
                if (idInput) {
                    idInput.value = evaluationId;
                }
            }
            
            evaluation.setAttribute('data-eval-index', evalIndex);
            
            evaluation.querySelectorAll('[name]').forEach(field => {
                if (field.type === 'hidden' && field.name.includes('id')) {
                    return;
                }
                
                const newName = field.name.replace(/evaluations-\d+-/, `evaluations-${evalIndex}-`);
                field.name = newName;
                field.id = newName;
            });

            // Reindex the capacities
            const capacites = evaluation.querySelectorAll('.capacite-item');
            capacites.forEach((capacite, capIndex) => {
                capacite.querySelectorAll('[name]').forEach(field => {
                    if (field.type === 'hidden' && field.name.includes('id')) {
                        return;
                    }
                    
                    const newName = field.name.replace(
                        /evaluations-\d+-capacites-\d+-/,
                        `evaluations-${evalIndex}-capacites-${capIndex}-`
                    );
                    field.name = newName;
                    field.id = newName;
                });
            });
        });
    }


    // Initialisation du drag & drop pour le calendrier
    function initDragAndDrop() {
        document.querySelectorAll('.calendar-item').forEach(item => {
            item.setAttribute('draggable', 'true');
            
            item.addEventListener('dragstart', function(e) {
                draggedItem = this;
                setTimeout(() => this.classList.add('dragging'), 0);
            });

            item.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                document.querySelectorAll('.calendar-item').forEach(item => {
                    item.classList.remove('drag-over');
                });
            });

            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                if (this !== draggedItem) {
                    this.classList.add('drag-over');
                }
            });

            item.addEventListener('dragleave', function() {
                this.classList.remove('drag-over');
            });

            item.addEventListener('drop', function(e) {
                e.preventDefault();
                if (this !== draggedItem) {
                    const allItems = [...document.querySelectorAll('.calendar-item')];
                    const draggedIndex = allItems.indexOf(draggedItem);
                    const droppedIndex = allItems.indexOf(this);

                    if (draggedIndex < droppedIndex) {
                        this.parentNode.insertBefore(draggedItem, this.nextSibling);
                    } else {
                        this.parentNode.insertBefore(draggedItem, this);
                    }

                    reindexCalendrier();
                }
                this.classList.remove('drag-over');
            });

            // Empêcher le drag & drop sur les champs de formulaire
            item.querySelectorAll('input, select, textarea').forEach(field => {
                field.addEventListener('mousedown', e => e.stopPropagation());
            });
        });
    }

    // Initialiser le drag & drop au chargement
    initDragAndDrop();

    // Génération automatique du calendrier via l'IA
    document.getElementById('generate-calendar')?.addEventListener('click', async function() {
        const button = this;
        const container = document.getElementById('calendrier-container');
        container.style.display = 'block';

        // Ajouter overlay de chargement
        const loadingOverlay = document.createElement('div');
        loadingOverlay.className = 'loading-overlay';
        loadingOverlay.innerHTML = `
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
                <div class="loading-text">Génération en cours...</div>
            </div>
        `;
        container.style.position = 'relative';
        container.appendChild(loadingOverlay);
        button.classList.add('loading');
        button.disabled = true;
        try {
            const payload = {
                cours_id: {{ cours.id }},
                session: "{{ plan_de_cours.session }}"
            };
            const response = await fetch("{{ url_for('plan_de_cours.generate_calendar') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': "{{ csrf_token() }}"
                },
                body: JSON.stringify(payload),
                credentials: 'same-origin'
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'Erreur inconnue');
            }

            const data = await response.json();
            const overlay = container.querySelector('.loading-overlay');
            if (overlay) {
                overlay.remove();
            }
            container.innerHTML = '';
            if (data.entries && data.entries.length > 0) {
                container.style.display = 'block';
                data.entries.forEach((entry, index) => {
                    const newItem = document.createElement('div');
                    newItem.className = `calendar-item border p-2 mb-2 ${index % 2 === 0 ? 'bg-light' : 'bg-secondary text-white'}`;
                    newItem.innerHTML = document.getElementById('calendrier-template').innerHTML.replace(/__index__/g, index);
                    newItem.querySelector(`[name="calendriers-${index}-semaine"]`).value = entry.semaine ?? '';
                    newItem.querySelector(`[name="calendriers-${index}-sujet"]`).value = entry.sujet ?? '';
                    newItem.querySelector(`[name="calendriers-${index}-activites"]`).value = entry.activites ?? '';
                    newItem.querySelector(`[name="calendriers-${index}-travaux_hors_classe"]`).value = entry.travaux_hors_classe ?? '';
                    newItem.querySelector(`[name="calendriers-${index}-evaluations"]`).value = entry.evaluations ?? '';
                    container.appendChild(newItem);
                });
                calendrierIndex = data.entries.length;
                initDragAndDrop();
                window.showFloatingButtons();
                showToast('generateSuccessToast');
            } else {
                showToast('generateErrorToast');
            }
        } catch (error) {
            console.error('Erreur lors de la génération du calendrier:', error);
            showToast('generateErrorToast');
        } finally {
            const overlay = container.querySelector('.loading-overlay');
            if (overlay) {
                overlay.remove();
            }
            button.classList.remove('loading');
            button.disabled = false;
        }
    });

    // Gestion du bouton d'ajout de calendrier
    document.getElementById('add-calendrier')?.addEventListener('click', function() {
        const container = document.getElementById('calendrier-container');
        container.style.display = 'block';
        const newItem = document.createElement('div');
        newItem.className = 'calendar-item border p-2 mb-2';
        newItem.innerHTML = document.getElementById('calendrier-template').innerHTML
            .replace(/__index__/g, calendrierIndex++);
        container.appendChild(newItem);
        initDragAndDrop();
        window.showFloatingButtons();
    });

    // Gestion du bouton d'ajout de médiagraphie
    document.getElementById('add-mediagraphie')?.addEventListener('click', function() {
        const container = document.getElementById('mediagraphie-container');
        container.style.display = 'block';
        const newItem = document.createElement('div');
        newItem.className = 'mediagraphie-item mb-2';
        newItem.innerHTML = document.getElementById('mediagraphie-template').innerHTML
            .replace(/__index__/g, mediagraphieIndex++);
        container.appendChild(newItem);
        window.showFloatingButtons();
    });

    // Gestion du bouton d'ajout de disponibilité
    document.getElementById('add-disponibilite')?.addEventListener('click', function() {
        const container = document.getElementById('disponibilites-container');
        container.style.display = 'block';
        const newItem = document.createElement('div');
        newItem.className = 'disponibilite-item mb-2';
        newItem.innerHTML = document.getElementById('disponibilite-template').innerHTML
            .replace(/__index__/g, disponibiliteIndex++);
        container.appendChild(newItem);
        window.showFloatingButtons();
    });

// Modification de la fonction d'ajout d'évaluation
    document.getElementById('add-evaluation')?.addEventListener('click', function() {
        const container = document.getElementById('evaluations-container');
        container.style.display = 'block';
        
        const newItem = document.createElement('div');
        const evalIndex = document.querySelectorAll('.evaluation-item').length;
        
        newItem.className = 'evaluation-item border p-2 mb-2';
        newItem.setAttribute('data-eval-index', evalIndex);
        // Don't set data-evaluation-id for new items
        
        let template = document.getElementById('evaluation-template').innerHTML;
        template = template.replace(/__index__/g, evalIndex);
        newItem.innerHTML = template;
        
        // Ensure the hidden ID field is empty for new evaluations
        const idInput = newItem.querySelector(`input[name="evaluations-${evalIndex}-id"]`);
        if (idInput) {
            idInput.value = '';
        }
        
        container.appendChild(newItem);
        reindexEvaluations();
        window.showFloatingButtons();
    });

    // Gestion des boutons de suppression
    document.addEventListener('click', function(e) {
        const button = e.target.closest('.remove-calendar, .remove-mediagraphie, .remove-disponibilite, .remove-evaluation, .remove-capacite');
        if (button) {
            const parentDiv = button.closest('.calendar-item, .mediagraphie-item, .disponibilite-item, .evaluation-item, .capacite-item');
            if (parentDiv) {
                parentDiv.remove();
                if (parentDiv.classList.contains('evaluation-item')) {
                    reindexEvaluations();
                }
                if (parentDiv.classList.contains('calendar-item')) {
                    reindexCalendrier();
                }
                const container = parentDiv.parentElement;
                if (container && container.children.length === 0) {
                    container.style.display = 'none';
                }
                window.showFloatingButtons();
            }
        }
    });

// Modification de la fonction d'ajout de capacité
document.addEventListener('click', function(e) {
    const button = e.target.closest('.add-capacite');
    if (button) {
        const evaluationItem = button.closest('.evaluation-item');
        if (!evaluationItem) return;
        
        const evalIndex = evaluationItem.getAttribute('data-eval-index');
        const capacitesContainer = evaluationItem.querySelector('.capacites-container');
        if (!capacitesContainer) return;
        
        const capIndex = capacitesContainer.querySelectorAll('.capacite-item').length;
        const newCap = document.createElement('div');
        newCap.className = 'capacite-item mb-2 border p-2';
        
        // Utiliser le template avec les index corrects
        let template = document.getElementById('evaluation-capacite-template').innerHTML;
        template = template
            .replace(/__eval_index__/g, evalIndex)
            .replace(/__cap_index__/g, capIndex);
        newCap.innerHTML = template;
        
        // Copier les options du select caché
        const hiddenSelect = document.getElementById('capacites-hidden');
        const newSelect = newCap.querySelector('select');
        if (hiddenSelect && newSelect) {
            newSelect.innerHTML = hiddenSelect.innerHTML;
        }
        
        capacitesContainer.appendChild(newCap);
        window.showFloatingButtons();
    }
});

    // Import DOCX handling (Celery-based)
    function applyImportPayloadToUI(data) {
        if (data?.fields) {
            for (const [key, val] of Object.entries(data.fields)) {
                const el = document.getElementById(key);
                if (!el) continue;
                el.value = val ?? '';
                if (el.toastEditor) el.toastEditor.setMarkdown(val ?? '');
            }
        }
        // Calendrier
        const calCont = document.getElementById('calendrier-container');
        if (calCont) {
            calCont.innerHTML = '';
            const entries = data?.calendriers || [];
            if (entries.length > 0) {
                calCont.style.display = 'block';
                entries.forEach((entry, index) => {
                    const newItem = document.createElement('div');
                    newItem.className = `calendar-item border p-2 mb-2 ${index % 2 === 0 ? 'bg-light' : 'bg-secondary text-white'}`;
                    newItem.innerHTML = document.getElementById('calendrier-template').innerHTML.replace(/__index__/g, index);
                    newItem.querySelector(`[name="calendriers-${index}-semaine"]`).value = entry.semaine ?? '';
                    newItem.querySelector(`[name="calendriers-${index}-sujet"]`).value = entry.sujet ?? '';
                    newItem.querySelector(`[name="calendriers-${index}-activites"]`).value = entry.activites ?? '';
                    newItem.querySelector(`[name="calendriers-${index}-travaux_hors_classe"]`).value = entry.travaux_hors_classe ?? '';
                    newItem.querySelector(`[name="calendriers-${index}-evaluations"]`).value = entry.evaluations ?? '';
                    calCont.appendChild(newItem);
                });
                calendrierIndex = entries.length;
                if (typeof initDragAndDrop === 'function') initDragAndDrop();
            } else {
                calCont.style.display = 'none';
            }
        }
        // Médiagraphies
        const medCont = document.getElementById('mediagraphie-container');
        if (medCont) {
            medCont.innerHTML = '';
            const list = data?.mediagraphies || [];
            if (list.length > 0) {
                medCont.style.display = 'block';
                list.forEach((m, index) => {
                    const newItem = document.createElement('div');
                    newItem.className = 'mediagraphie-item mb-2';
                    newItem.innerHTML = document.getElementById('mediagraphie-template').innerHTML.replace(/__index__/g, index);
                    newItem.querySelector(`[name="mediagraphies-${index}-reference_bibliographique"]`).value = m.reference_bibliographique ?? '';
                    medCont.appendChild(newItem);
                });
                mediagraphieIndex = list.length;
            } else {
                medCont.style.display = 'none';
            }
        }
        // Disponibilités
        const dispCont = document.getElementById('disponibilites-container');
        if (dispCont) {
            dispCont.innerHTML = '';
            const list = data?.disponibilites || [];
            if (list.length > 0) {
                dispCont.style.display = 'block';
                list.forEach((d, index) => {
                    const newItem = document.createElement('div');
                    newItem.className = 'disponibilite-item mb-2';
                    newItem.innerHTML = document.getElementById('disponibilite-template').innerHTML.replace(/__index__/g, index);
                    newItem.querySelector(`[name="disponibilites-${index}-jour_semaine"]`).value = d.jour_semaine ?? '';
                    newItem.querySelector(`[name="disponibilites-${index}-plage_horaire"]`).value = d.plage_horaire ?? '';
                    newItem.querySelector(`[name="disponibilites-${index}-lieu"]`).value = d.lieu ?? '';
                    dispCont.appendChild(newItem);
                });
                disponibiliteIndex = list.length;
            } else {
                dispCont.style.display = 'none';
            }
        }
        // Évaluations
        const evalCont = document.getElementById('evaluations-container');
        const hiddenCaps = document.getElementById('capacites-hidden');
        if (evalCont) {
            evalCont.innerHTML = '';
            const list = data?.evaluations || [];
            if (list.length > 0) {
                evalCont.style.display = 'block';
                list.forEach((ev, evalIndex) => {
                    const newItem = document.createElement('div');
                    newItem.className = `card mb-3 evaluation-item ${evalIndex % 2 === 0 ? 'bg-light' : 'bg-secondary text-white'}`;
                    newItem.setAttribute('data-eval-index', String(evalIndex));
                    newItem.innerHTML = document.getElementById('evaluation-template').innerHTML.replace(/__index__/g, evalIndex);
                    newItem.querySelector(`[name="evaluations-${evalIndex}-titre_evaluation"]`).value = ev.titre_evaluation ?? '';
                    newItem.querySelector(`[name="evaluations-${evalIndex}-semaine"]`).value = ev.semaine ?? '';
                    newItem.querySelector(`[name="evaluations-${evalIndex}-texte_description"]`).value = ev.description ?? '';
                    const capsContainer = newItem.querySelector('.capacites-container');
                    capsContainer.innerHTML = '';
                    (ev.capacites || []).forEach((cap, capIndex) => {
                        const capItem = document.createElement('div');
                        capItem.className = 'capacite-item mb-2 border p-2';
                        capItem.innerHTML = document.getElementById('evaluation-capacite-template').innerHTML
                            .replace(/__eval_index__/g, evalIndex)
                            .replace(/__cap_index__/g, capIndex);
                        const select = capItem.querySelector('select');
                        if (hiddenCaps) select.innerHTML = hiddenCaps.innerHTML;
                        if (cap.capacite_id) {
                            select.value = String(cap.capacite_id);
                        } else if (cap.capacite_nom) {
                            const opt = Array.from(select.options).find(o => o.text === cap.capacite_nom);
                            if (opt) select.value = opt.value;
                        }
                        capItem.querySelector(`[name="evaluations-${evalIndex}-capacites-${capIndex}-ponderation"]`).value = cap.ponderation ?? '';
                        capsContainer.appendChild(capItem);
                    });
                    evalCont.appendChild(newItem);
                });
                evaluationIndex = list.length;
            } else {
                evalCont.style.display = 'none';
            }
        }
        if (window.showFloatingButtons) window.showFloatingButtons();
    }

    const importForm = document.getElementById('importDocxForm');
    const importBtn = document.getElementById('confirmImportDocxBtn');
    if (importForm) {
      importForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const fileInput = document.getElementById('docxFile');
        if (!fileInput?.files?.length) return;
        importBtn?.setAttribute('disabled', 'disabled');
        importBtn?.classList.add('disabled');
        try {
            // Define completion handler so base polling updates UI when task finishes
            window.onTaskCompleted = function(payload) {
                try { applyImportPayloadToUI(payload); } catch (e) { console.error('applyImportPayloadToUI error', e); }
                const toast = document.getElementById('generateSuccessToast');
                if (toast) new bootstrap.Toast(toast).show();
            };

            const fd = new FormData();
            fd.append('file', fileInput.files[0]);
            fd.append('cours_id', String({{ cours.id }}));
            fd.append('session', "{{ plan_de_cours.session }}");
            const aiModelEl = document.getElementById('importDocxAiModel');
            if (aiModelEl && aiModelEl.value) {
                fd.append('ai_model', aiModelEl.value);
            }
            const resp = await fetch("{{ url_for('plan_de_cours.import_docx_start') }}", {
                method: 'POST',
                body: fd,
                credentials: 'same-origin',
                headers: { 'X-CSRFToken': "{{ csrf_token() }}" }
            });
            const data = await resp.json();
            if (!resp.ok || data.success === false || !data.task_id) throw new Error(data.message || 'Échec lancement import');

            const modalEl = document.getElementById('importDocxModal');
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();
            if (typeof sessionStorage !== 'undefined') sessionStorage.setItem('currentTaskId', data.task_id);
            if (typeof startTaskPolling === 'function') startTaskPolling(data.task_id);
        } catch (err) {
            console.error('Erreur import DOCX (start)', err);
            const toast = document.getElementById('generateErrorToast');
            if (toast) new bootstrap.Toast(toast).show();
        } finally {
            importBtn?.removeAttribute('disabled');
            importBtn?.classList.remove('disabled');
            importForm.reset();
        }
      });
    }

    // Gestion de la sauvegarde
    if (floatingSaveBtn && planDeCoursForm) {
        floatingSaveBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            this.classList.add('loading');
            this.disabled = true;

            try {
                // Add this ID preservation code before creating FormData
                document.querySelectorAll('.evaluation-item').forEach(evaluationItem => {
                    if (evaluationItem.hasAttribute('data-evaluation-id')) {
                        const evaluationId = evaluationItem.getAttribute('data-evaluation-id');
                        const index = evaluationItem.getAttribute('data-eval-index');
                        const idInput = evaluationItem.querySelector(`input[name="evaluations-${index}-id"]`);
                        if (idInput) {
                            idInput.value = evaluationId;
                        }
                    }
                });

                // Rest of your existing form submission code...
                const formData = new FormData(planDeCoursForm);
                
                // Obtention du token CSRF depuis le formulaire
                const csrfToken = planDeCoursForm.querySelector('input[name="csrf_token"]')?.value;
                if (csrfToken) {
                    formData.append('csrf_token', csrfToken);
                }

                // Envoi de la requête
                const response = await fetch(planDeCoursForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'  // Important pour les cookies de session
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Erreur HTTP: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    this.classList.add('d-none');
                    floatingCancelBtn.classList.add('d-none');
                    
                    // Afficher le toast de succès
                    const toast = new bootstrap.Toast(document.getElementById('saveSuccessToast'));
                    toast.show();

                    // Mettre à jour les indices après la sauvegarde
                    calendrierIndex = document.querySelectorAll('.calendar-item').length;
                    mediagraphieIndex = document.querySelectorAll('.mediagraphie-item').length;
                    disponibiliteIndex = document.querySelectorAll('.disponibilite-item').length;
                    evaluationIndex = document.querySelectorAll('.evaluation-item').length;
                } else {
                    throw new Error(result.message || 'Erreur lors de la sauvegarde');
                }
            } catch (error) {
                console.error('Erreur:', error);
                // Afficher le message d'erreur dans le toast
                const errorToast = new bootstrap.Toast(document.getElementById('saveErrorToast'));
                const errorToastBody = document.querySelector('#saveErrorToast .toast-body');
                if (errorToastBody) {
                    errorToastBody.textContent = `Une erreur est survenue lors de la sauvegarde: ${error.message}`;
                }
                errorToast.show();
            } finally {
                this.classList.remove('loading');
                this.disabled = false;
            }
        });
    }

    // Gestion du bouton d'annulation
    if (floatingCancelBtn) {
        floatingCancelBtn.addEventListener('click', async function() {
            if (confirm('Êtes-vous sûr de vouloir annuler les modifications ?')) {
                try {
                    const currentUrl = window.location.href;
                    const response = await fetch(currentUrl);
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    ['calendrier-container', 'mediagraphie-container', 'disponibilites-container', 'evaluations-container'].forEach(containerId => {
                        const container = document.getElementById(containerId);
                        const newContent = doc.getElementById(containerId);
                        if (container && newContent) {
                            container.innerHTML = newContent.innerHTML;
                            container.style.display = newContent.children.length > 0 ? 'block' : 'none';
                        }
                    });
                    
                    planDeCoursForm?.reset();
                    calendrierIndex = document.querySelectorAll('.calendar-item').length;
                    mediagraphieIndex = document.querySelectorAll('.mediagraphie-item').length;
                    disponibiliteIndex = document.querySelectorAll('.disponibilite-item').length;
                    evaluationIndex = document.querySelectorAll('.evaluation-item').length;
                    
                    initDragAndDrop();
                    floatingSaveBtn?.classList.add('d-none');
                    floatingCancelBtn?.classList.add('d-none');
                } catch (error) {
                    console.error('Erreur lors de la restauration:', error);
                    window.location.reload();
                }
            }
        });
    }

    // Écouter les modifications du formulaire
    if (planDeCoursForm) {
        planDeCoursForm.addEventListener('input', window.showFloatingButtons);
        planDeCoursForm.addEventListener('change', window.showFloatingButtons);
    }

    // Initialiser l'état des conteneurs
    ['calendrier-container', 'mediagraphie-container', 'disponibilites-container', 'evaluations-container'].forEach(function(id) {
        const container = document.getElementById(id);
        if (container && container.children.length === 0) {
            container.style.display = 'none';
        }
    });

    // Génération de toutes les sections (texte + calendrier) via un seul appel
    document.getElementById('generate-all')?.addEventListener('click', async function() {
        const btn = this;
        btn.classList.add('loading');
        btn.disabled = true;

        const csrfToken = "{{ csrf_token() }}";
        const payload = {
            cours_id: {{ cours.id }},
            session: "{{ plan_de_cours.session }}"
        };

        try {
            const resp = await fetch("{{ url_for('plan_de_cours.generate_all') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(payload),
                credentials: 'same-origin'
            });

            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const data = await resp.json();

            // Mettre à jour les champs texte
            if (data.fields) {
                for (const [key, val] of Object.entries(data.fields)) {
                    const el = document.getElementById(key);
                    if (!el) continue;
                    el.value = val ?? '';
                    if (el.toastEditor) {
                        el.toastEditor.setMarkdown(val ?? '');
                    }
                }
            }

            // Mettre à jour le calendrier
            const container = document.getElementById('calendrier-container');
            if (container) {
                container.innerHTML = '';
                const entries = data.calendriers || [];
                if (entries.length > 0) {
                    container.style.display = 'block';
                    entries.forEach((entry, index) => {
                        const newItem = document.createElement('div');
                        newItem.className = `calendar-item border p-2 mb-2 ${index % 2 === 0 ? 'bg-light' : 'bg-secondary text-white'}`;
                        newItem.innerHTML = document.getElementById('calendrier-template').innerHTML.replace(/__index__/g, index);
                        newItem.querySelector(`[name="calendriers-${index}-semaine"]`).value = entry.semaine ?? '';
                        newItem.querySelector(`[name="calendriers-${index}-sujet"]`).value = entry.sujet ?? '';
                        newItem.querySelector(`[name="calendriers-${index}-activites"]`).value = entry.activites ?? '';
                        newItem.querySelector(`[name="calendriers-${index}-travaux_hors_classe"]`).value = entry.travaux_hors_classe ?? '';
                        newItem.querySelector(`[name="calendriers-${index}-evaluations"]`).value = entry.evaluations ?? '';
                        container.appendChild(newItem);
                    });
                    calendrierIndex = entries.length;
                    initDragAndDrop();
                    if (window.showFloatingButtons) window.showFloatingButtons();
                } else {
                    container.style.display = 'none';
                }
            }

            const toast = document.getElementById('generateSuccessToast');
            if (toast) new bootstrap.Toast(toast).show();
        } catch (e) {
            console.error('Erreur génération complète du plan de cours', e);
            const toast = document.getElementById('generateErrorToast');
            if (toast) new bootstrap.Toast(toast).show();
        }

        btn.classList.remove('loading');
        btn.disabled = false;
    });
});
</script>

<!-- Modal Import DOCX (moved outside accordion to avoid collapse visibility issues) -->
<div class="modal fade" id="importDocxModal" tabindex="-1" aria-labelledby="importDocxModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="importDocxModalLabel">Importer un plan de cours (.docx)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="importDocxForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="docxFile" class="form-label">Fichier .docx</label>
            <input class="form-control" type="file" id="docxFile" name="file" accept=".docx" required>
          </div>
          <div class="mb-3">
            <label for="importDocxAiModel" class="form-label">Modèle d'IA</label>
            {{ generate_form.ai_model(class="form-select border-0", id="importDocxAiModel") }}
          </div>
          <div class="small text-muted">Le contenu sera analysé pour remplir les sections, y compris évaluations, informations prof, disponibilités et médiagraphie.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" id="confirmImportDocxBtn" class="btn btn-primary">Importer</button>
        </div>
      </form>
    </div>
  </div>
  </div>

<!-- Modal Génération du Plan de Cours (similaire au plan-cadre) -->
<div class="modal fade" id="generatePlanCoursModal" tabindex="-1" aria-labelledby="generatePlanCoursLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form id="generatePlanCoursForm">
        {{ generate_form.hidden_tag() }}
        <div class="modal-header">
          <h5 class="modal-title" id="generatePlanCoursLabel">Générer le plan de cours</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            {{ generate_form.additional_info.label(class="form-label") }}
            {{ generate_form.additional_info(class="form-control border-0", rows="3", placeholder="Ajoutez des précisions utiles (public cible, modalités, logiciels, etc.)") }}
          </div>
          <div class="mb-3">
            {{ generate_form.ai_model.label(class="form-label") }}
            {{ generate_form.ai_model(class="form-select border-0") }}
          </div>
          <div class="mb-3">
            {{ generate_form.reasoning_effort.label(class="form-label") }}
            {{ generate_form.reasoning_effort(class="form-select border-0") }}
          </div>
          <div class="mb-3">
            {{ generate_form.verbosity.label(class="form-label") }}
            {{ generate_form.verbosity(class="form-select border-0") }}
          </div>
          <div class="form-text">La génération remplira toutes les sections disponibles et le calendrier.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary" id="confirmGeneratePlanCoursBtn">
            <span class="btn-text">Générer</span>
            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" id="modalLoadingSpinnerPlanCours">
              <span class="visually-hidden">Chargement...</span>
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
  </div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="saveSuccessToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                Le plan de cours a été sauvegardé avec succès!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
    <div id="saveErrorToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                Une erreur est survenue lors de la sauvegarde.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
    <!-- Toast pour la génération automatique réussie -->
    <div id="generateSuccessToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                Le contenu a été généré avec succès!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>

    <!-- Toast pour la génération automatique en échec -->
    <div id="generateErrorToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                Une erreur est survenue lors de la génération du contenu.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>
{% endblock %}
