{% extends "parametres.html" %}

{% block head %}
    {{ super() }}
    {% include '_easymde_assets.html' %}
{% endblock %}

{% block parametres_content %}
<div class="container my-5">
    <h1 class="mb-4">Modifier la RÃ¨gle PIEA</h1>
    <div class="card">
        <div class="card-body">
            <form method="POST">
                {{ form.hidden_tag() }}
                <div class="mb-3">
                    {{ form.article.label(class="form-label") }}
                    {{ form.article(class="form-control") }}
                </div>
                <div class="mb-3">
                    {{ form.contenu.label(class="form-label") }}
                    {{ form.contenu(class="form-control toast-editor", rows="3") }}
                </div>
                <button type="submit" class="btn btn-primary">Sauvegarder</button>
                <a href="{{ url_for('settings.gestion_departements') }}" class="btn btn-secondary">Annuler</a>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    {% include '_easymde_assets.html' %}
    
    <script>
        function initToastEditor(textarea) {
            const mde = new EasyMDE({
                element: textarea,
                autoDownloadFontAwesome: false,
                spellChecker: false,
                autofocus: false,
                minHeight: '200px',
                status: false,
                forceSync: true,
                toolbar: ['bold','italic','|','unordered-list','ordered-list','|','guide'],
            });
            mde.codemirror.on('change', () => { textarea.value = mde.value(); });

            // A11y: label association for CodeMirror inner textarea
            try {
                const cmInput = mde.codemirror.getInputField && mde.codemirror.getInputField();
                if (cmInput) {
                    let labelEl = null;
                    if (textarea.id) labelEl = document.querySelector(`label[for="${textarea.id}"]`);
                    if (labelEl) {
                        if (!labelEl.id) labelEl.id = `${textarea.id}-label`;
                        cmInput.setAttribute('aria-labelledby', labelEl.id);
                    } else if (textarea.getAttribute('placeholder')) {
                        cmInput.setAttribute('aria-label', textarea.getAttribute('placeholder'));
                    } else {
                        cmInput.setAttribute('aria-label', 'Zone de texte');
                    }
                }
            } catch {}
            const container = textarea.closest('.EasyMDEContainer') || textarea.parentElement;
            const toolbar = container ? container.querySelector('.editor-toolbar') : null;
            if (toolbar) toolbar.style.display = 'none';
            if (container) {
                container.addEventListener('focusin', () => { if (toolbar) toolbar.style.display = 'block'; });
                container.addEventListener('focusout', (e) => {
                    if (!container.contains(e.relatedTarget) && toolbar) {
                        const selection = window.getSelection();
                        if (!selection.toString()) toolbar.style.display = 'none';
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('textarea.toast-editor').forEach(function(textarea) {
                initToastEditor(textarea);
            });
        });

        // Styliser EasyMDE comme les inputs Bootstrap
        const style = document.createElement('style');
        style.innerHTML = `
            .EasyMDEContainer .CodeMirror,
            .EasyMDEContainer {
                border: 1px solid #ced4da;
                border-radius: 4px;
                font-size: 1rem;
                font-family: inherit;
            }
            .EasyMDEContainer .CodeMirror { padding: 4px 8px; }
        `;
        document.head.appendChild(style);
    </script>
{% endblock %}
