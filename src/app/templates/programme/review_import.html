{% extends "base.html" %} {# Assurez-vous que votre base.html existe et fonctionne #}

{% block title %}Révision avant Import - {{ programme.nom }}{% endblock %} {# Utiliser programme.nom ou programme.nom_programme #}

{% block styles %}
{{ super() }}
<style>
    .review-container {
        display: flex;
        flex-wrap: wrap; /* Permet le retour à la ligne sur petits écrans */
        gap: 20px;
        margin-bottom: 20px;
    }
    .review-column {
        flex: 1;
        min-width: 300px; /* Empêche les colonnes d'être trop étroites */
        border: 1px solid #ccc;
        padding: 15px;
        border-radius: 5px;
        background-color: #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .review-column-content {
        overflow-y: auto;
        max-height: 70vh; /* Ajustez si nécessaire */
        padding-right: 10px; /* Espace pour la barre de défilement */
    }
    .review-column h3 {
        margin-top: 0;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
        font-size: 1.25rem;
        color: #333;
    }
    .competence-block {
        margin-bottom: 15px;
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        background-color: #f9f9f9;
    }
    .competence-block h5 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 1.1em;
        color: #0056b3; /* Couleur pour le titre de la compétence */
    }
    .competence-block strong {
        color: #444;
    }
    .competence-block ul {
        padding-left: 20px;
        margin-bottom: 5px;
        margin-top: 5px;
        list-style-type: disc;
    }
    .competence-block li {
         font-size: 0.95em;
         color: #555;
         margin-bottom: 3px;
    }
    #ocr-content-wrapper { /* Conteneur pour le pre */
        overflow-x: auto; /* Défilement horizontal si lignes longues */
    }
    #ocr-content {
        white-space: pre-wrap;
        word-wrap: break-word; /* Pour les mots très longs */
        font-family: Consolas, 'Courier New', Courier, monospace;
        font-size: 0.9em;
        line-height: 1.4;
        background-color: #fdfdfd;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Révision avant Import : {{ programme.nom }} {% if programme.code_ministeriel %}({{ programme.code_ministeriel }}){% endif %}</h2>
    <p>Vérifiez les informations extraites du devis <strong>{{ base_filename }}</strong> avant de confirmer l'importation des compétences dans la base de données pour ce programme.</p>

    {# Les flash messages seront affichés via base.html, aucune inclusion ici n'est nécessaire #}

    <div class="review-container mt-3">
        {# Colonne Gauche: Texte OCR Brut (Markdown) #}
        <div class="review-column">
            <h3>Texte OCR (Markdown)</h3>
            <div class="review-column-content">
                {% if ocr_text %}
                    <div id="ocr-content-wrapper">
                        <pre id="ocr-content"><code>{{ ocr_text }}</code></pre>
                    </div>
                {% else %}
                    <div class="alert alert-warning">Le contenu du fichier Markdown n'a pas pu être chargé.</div>
                {% endif %}
            </div>
        </div>

        {# Colonne Droite: Compétences Structurées (JSON) #}
        <div class="review-column">
            <h3>Compétences Structurées (JSON)</h3>
             <div class="review-column-content">
                {% if has_competencies_file and competencies_data %}
                    {% if competencies_data.competences is defined and competencies_data.competences | length > 0 %}
                         {% for comp in competencies_data.competences %}
                            <div class="competence-block">
                                <h5>{{ comp.code }}: {{ comp.enonce or comp.nom or 'Nom/Énoncé Manquant' }}</h5>
                                {% if comp.contexte_de_realisation %}
                                    <p><small><strong>Contexte:</strong> {{ comp.contexte_de_realisation }}</small></p>
                                {% endif %}
                                {% if comp.criteria_de_performance and comp.criteria_de_performance | length > 0 %}
                                     <strong>Critères de performance (Globaux) :</strong>
                                     <ul>
                                         {% for crit_g in comp.criteria_de_performance %}
                                            <li>{{ crit_g }}</li>
                                         {% endfor %}
                                     </ul>
                                {% endif %}
                                {% set elements = comp.elements or comp.element or [] %}
                                {% if elements | length > 0 %}
                                    <strong>Éléments de compétence :</strong>
                                    <ul>
                                    {% for elem in elements %}
                                        {% if elem is string %}
                                            <li>{{ elem }}</li>
                                        {% elif elem is mapping %}
                                            <li>
                                                <strong>{{ elem.element or elem.nom or 'Élément ?' }}:</strong>
                                                {% set criteres_elem = elem.criteres or elem.critere_performance %}
                                                {% if criteres_elem %}
                                                    {% if criteres_elem is iterable and criteres_elem is not string %}
                                                        <ul>
                                                        {% for crit_e in criteres_elem %}
                                                            <li>{{ crit_e }}</li>
                                                        {% endfor %}
                                                        </ul>
                                                    {% elif criteres_elem is string %}
                                                         : {{ criteres_elem }}
                                                    {% endif %}
                                                {% endif %}
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    </ul>
                                {% else %}
                                    <small class="text-muted">Aucun élément de compétence listé pour cette compétence.</small>
                                {% endif %}
                            </div>
                         {% endfor %}
                    {% else %}
                         <div class="alert alert-info">Aucune compétence trouvée dans la structure du fichier JSON.</div>
                    {% endif %}
                {% elif has_competencies_file and not competencies_data %}
                     <div class="alert alert-danger">Le fichier JSON a été trouvé mais n'a pas pu être lu ou est invalide. Vérifiez sa structure.</div>
                {% else %}
                    <div class="alert alert-info">Aucun fichier JSON de compétences structurées trouvé. Seule la confirmation du texte OCR est possible via le bouton ci-dessous.</div>
                {% endif %}
             </div>
        </div>
    </div>

    <form action="{{ url_for('programme.confirm_competencies_import') }}" method="POST" class="mt-4">
        {{ form.hidden_tag() }}
        {% if has_competencies_file and competencies_data and competencies_data.competences is defined and competencies_data.competences | length > 0 %}
             <button type="submit" name="submit_button" value="confirm_import" class="btn btn-success">
                 <i class="bi bi-database-add"></i> Confirmer et Importer ces Compétences
             </button>
             <small class="form-text text-muted d-block">Importer les compétences structurées affichées ci-dessus pour le programme sélectionné.</small>
        {% else %}
             <button type="submit" name="submit_button" value="confirm_ocr" class="btn btn-secondary">
                 <i class="bi bi-check-lg"></i> Confirmer le Texte OCR uniquement
             </button>
             <small class="form-text text-muted d-block">Confirme que le texte OCR a été révisé. Aucune importation de compétence structurée ne sera effectuée.</small>
        {% endif %}
        <a href="{{ url_for('programme.view_programme', programme_id=programme.id) }}" class="btn btn-outline-secondary ms-2">Annuler</a>
    </form>

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{# Optionnel: Ajouter ici le script pour une librairie de rendu Markdown (comme Marked.js) #}
{% endblock %}
