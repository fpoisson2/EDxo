{% extends "base.html" %}
{% block title %}Associer sections – {{ page.title }}{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    .mapping-row { display: grid; grid-template-columns: 220px 1fr auto; gap: .5rem; align-items: center; }
    .pointer-preview { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4">Associer les sections – {{ page.title }}</h1>
    <div class="btn-group">
      <a href="{{ url_for('main.docx_schema_entries_list_page', page_id=page.id) }}" class="btn btn-outline-secondary">Entrées</a>
      <a href="{{ url_for('main.docx_schema_page_view', page_id=page.id) }}" class="btn btn-outline-secondary">Schéma</a>
    </div>
  </div>

  <p class="text-muted">Reliez les sections du visionnement (sessions, cours) aux champs du schéma via des pointeurs JSON.</p>

  <div class="card">
    <div class="card-body">
      <div id="mappingList" class="vstack gap-2">
        {% for key in default_sections %}
        <div class="mapping-row" data-key="{{ key }}">
          <label class="form-label mb-0">{{ key }}</label>
          <input type="text" class="form-control form-control-sm pointer-input" value="{{ existing.get(key, '') }}" placeholder="#/properties/...">
          <button type="button" class="btn btn-sm btn-outline-secondary browse-btn" data-bs-toggle="modal" data-bs-target="#schemaPointerBrowseModal">Parcourir</button>
        </div>
        {% endfor %}
      </div>
      <div class="mt-3 text-end">
        <button id="mappingSaveBtn" class="btn btn-primary">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de parcours de schéma -->
<div class="modal fade" id="schemaPointerBrowseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Parcourir le schéma</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2"><input id="schemaPointerSearch" class="form-control form-control-sm" placeholder="Rechercher un champ ou chemin..."></div>
        <div id="schemaPointerTree" class="small"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const pageId = {{ page.id }};
  let schemaData = {{ page.json_schema | tojson }};
  try {
    if (typeof schemaData === 'string') {
      const t = schemaData.trim();
      if ((t.startsWith('{') && t.endsWith('}')) || (t.startsWith('[') && t.endsWith(']'))) schemaData = JSON.parse(t);
    }
    if (schemaData && typeof schemaData === 'object' && typeof schemaData.schema === 'string') {
      const t = schemaData.schema.trim();
      if ((t.startsWith('{') && t.endsWith('}')) || (t.startsWith('[') && t.endsWith(']'))) schemaData = JSON.parse(t);
    }
  } catch {}

  const mappingList = document.getElementById('mappingList');
  const saveBtn = document.getElementById('mappingSaveBtn');
  const browseModalEl = document.getElementById('schemaPointerBrowseModal');
  const browseTree = document.getElementById('schemaPointerTree');
  const searchInput = document.getElementById('schemaPointerSearch');
  const browseModal = (typeof bootstrap !== 'undefined') ? new bootstrap.Modal(browseModalEl) : null;
  let activeInput = null;

  function getCookie(name) {
    const m = document.cookie.match('(?:^|; )' + name.replace(/([.$?*|{}()\\[\\]\\/\\+^])/g, '\\$1') + '=([^;]*)');
    return m ? decodeURIComponent(m[1]) : undefined;
  }

  function walk(schema, ptr, parent) {
    const row = document.createElement('div');
    row.className = 'list-group-item py-1 d-flex justify-content-between';
    const label = document.createElement('span');
    const code = document.createElement('code');
    label.textContent = (schema && (schema.title || schema.titre)) || ptr.split('/').pop() || 'root';
    code.textContent = ptr;
    row.appendChild(label);
    row.appendChild(code);
    row.addEventListener('click', (e) => {
      e.preventDefault();
      if (activeInput) activeInput.value = ptr;
      if (browseModal) browseModal.hide();
    });
    parent.appendChild(row);

    if (!schema || typeof schema !== 'object') return;
    if (schema.type === 'object' && schema.properties) {
      const props = Object.entries(schema.properties);
      for (const [name, s] of props) {
        const child = document.createElement('div');
        child.className = 'list-group ms-3';
        parent.appendChild(child);
        walk(s, `${ptr}/properties/${name}`, child);
      }
    } else if (schema.type === 'array' && schema.items) {
      const child = document.createElement('div');
      child.className = 'list-group ms-3';
      parent.appendChild(child);
      walk(schema.items, `${ptr}/items`, child);
    }
    if (schema.$defs) {
      for (const [name, s] of Object.entries(schema.$defs)) {
        const child = document.createElement('div');
        child.className = 'list-group ms-3';
        parent.appendChild(child);
        walk(s, `${ptr}/$defs/${name}`, child);
      }
    }
  }

  function buildPointerTree() {
    browseTree.innerHTML = '';
    const root = document.createElement('div');
    root.className = 'list-group';
    browseTree.appendChild(root);
    walk(schemaData, '#', root);
  }

  mappingList.querySelectorAll('.browse-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      activeInput = btn.closest('.mapping-row').querySelector('.pointer-input');
    });
  });

  // Build tree each time modal is shown (works with data attributes)
  browseModalEl.addEventListener('show.bs.modal', () => {
    buildPointerTree();
  });

  saveBtn.addEventListener('click', async () => {
    const mappings = [];
    mappingList.querySelectorAll('.mapping-row').forEach(row => {
      const key = row.getAttribute('data-key');
      const pointer = row.querySelector('.pointer-input').value.trim();
      if (pointer) mappings.push({ section_key: key, pointer });
    });
    const base = (typeof window !== 'undefined' && window.APP_PREFIX) ? window.APP_PREFIX : '';
    const res = await fetch(`${base}/docx_schema/${pageId}/mapping`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrf_token') || ''
      },
      body: JSON.stringify({ mappings })
    });
    try {
      if (res.ok) {
        alert('Enregistré.');
      } else {
        const t = await res.text();
        console.error('Save error', res.status, t);
        alert('Erreur lors de la sauvegarde.');
      }
    } catch(e) {
      console.error('Save exception', e);
      alert('Erreur lors de la sauvegarde.');
    }
  });
});
</script>

{% endblock %}
