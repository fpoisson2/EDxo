{% extends "base.html" %}

{% block title %}Importation de la grille de cours{% endblock %}

{% block content %}
  <h1>Importation de la grille de cours</h1>
  <form id="grilleImportForm" method="POST" enctype="multipart/form-data">
      {{ form.hidden_tag() }}
      <div class="mb-3">
          {{ form.file.label(class_='form-label') }}
          {{ form.file(class_='form-control', id='grilleFile') }}
      </div>
      <div>
          {{ form.submit(class_='btn btn-primary') }}
      </div>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('grilleImportForm');
      if (!form) return;
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('grilleFile');
        if (!fileInput || !fileInput.files || !fileInput.files[0]) {
          try { addNotification('Sélectionnez un fichier PDF.', 'warning'); } catch(_) {}
          return;
        }
        const fd = new FormData(form);
        const csrf = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        try {
          const startUrl = '/grille/import';
          await window.EDxoTasks.startCeleryTask(startUrl, {
            method: 'POST',
            body: fd,
            headers: { 'X-CSRFToken': csrf, 'X-CSRF-Token': csrf },
            credentials: 'same-origin'
          }, {
            title: 'Import de la grille (PDF)',
            startMessage: 'Import en cours…',
            userPrompt: 'Extraction de la grille à partir du PDF fourni.',
            openModal: true,
            onDone: (payload, _state, taskId) => {
              const tid = taskId || (sessionStorage.getItem('currentTaskId')||'');
              const link = (payload && payload.validation_url) ? payload.validation_url : (`/confirm_grille_import/${tid}`);
              try { addNotification("Import terminé. Cliquez pour valider l'import.", 'success', link, tid); } catch(_) {}
            }
          });
        } catch (err) {
          console.error('Erreur import grille', err);
          try { addNotification('Erreur import: ' + (err.message||err), 'error', null, (sessionStorage.getItem('currentTaskId')||null)); } catch(_) {}
        }
      });
    });
  </script>
{% endblock %}
