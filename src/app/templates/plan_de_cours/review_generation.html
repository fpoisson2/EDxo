{% extends "base.html" %}
{% from "components/diff.html" import render_simple_diff %}
{% block title %}Comparaison — Plan de cours{% endblock %}
{% block content %}
<div class="container mt-4">
  <h1>Comparaison — Plan de cours</h1>
  {% if task_id %}
  <p class="text-muted">Tâche: <code>{{ task_id }}</code></p>
  {% endif %}

  <h4 class="mt-3">Champs principaux</h4>
  <div class="row g-3">
    {% for key, label in {
      'presentation_du_cours': 'Présentation du cours',
      'objectif_terminal_du_cours': 'Objectif terminal',
      'organisation_et_methodes': 'Organisation et méthodes',
      'accomodement': 'Accommodement',
      'evaluation_formative_apprentissages': 'Éval. formative',
      'evaluation_expression_francais': 'Éval. expression français',
      'materiel': 'Matériel',
    }.items() %}
      <div class="col-12">
        <h6 class="mb-2">{{ label }}</h6>
        {{ render_simple_diff(old_fields.get(key, ''), new_fields.get(key, ''), 'Avant', 'Après') }}
      </div>
    {% endfor %}
  </div>

  <h4 class="mt-4">Calendrier</h4>
  <div class="row g-3">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header">Avant</div>
        <div class="card-body">
          {% if old_calendriers %}
            <ul class="list-group">
              {% for c in old_calendriers %}
                <li class="list-group-item">
                  <strong>S{{ c.semaine }}</strong> — {{ c.sujet or '' }}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-muted">Aucun calendrier</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header">Après</div>
        <div class="card-body">
          {% if new_calendriers %}
            <ul class="list-group">
              {% for c in new_calendriers %}
                <li class="list-group-item">
                  <strong>S{{ c.semaine }}</strong> — {{ c.sujet or '' }}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-muted">Aucun calendrier</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="mt-4">
    <div class="d-flex gap-2">
      {% if plan %}
        <a href="/cours/{{ plan.cours_id }}/plan_de_cours/{{ plan.session }}/" class="btn btn-outline-secondary">Retour au plan</a>
      {% endif %}
      <button id="confirmBtn" class="btn btn-success">Confirmer</button>
      {% if task_id %}
        <button id="revertBtn" class="btn btn-warning">Restaurer l'ancienne version</button>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function(){
    const planId = {{ plan_id|int }};
    const taskId = {{ (task_id or '')|tojson }};
    const csrf = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    async function callApply(action) {
      try {
        const res = await fetch(`/plan_de_cours/review/${planId}/apply${taskId ? ('?task_id=' + encodeURIComponent(taskId)) : ''}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(csrf ? {'X-CSRFToken': csrf, 'X-CSRF-Token': csrf} : {})
          },
          body: JSON.stringify({ action, task_id: taskId })
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
          alert(data.message || 'Action échouée.');
          return;
        }
        try { addNotification('Modifications enregistrées.', 'success', data.redirect_url); } catch(_) {}
        if (data.redirect_url) window.location.href = data.redirect_url;
      } catch (e) {
        console.error(e);
        alert('Erreur réseau.');
      }
    }

    const confirmBtn = document.getElementById('confirmBtn');
    if (confirmBtn) confirmBtn.addEventListener('click', function(){ callApply('confirm'); });
    const revertBtn = document.getElementById('revertBtn');
    if (revertBtn) revertBtn.addEventListener('click', function(){ if (confirm("Restaurer l'ancienne version ?")) callApply('revert'); });
  })();
</script>
{% endblock %}
