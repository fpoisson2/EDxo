<!-- templates/add_competence.html and templates/edit_competence.html -->
{% extends "parametres.html" %}

{% block head %}
  {{ super() }}
  {% include '_easymde_assets.html' %}
  <!-- {{ ckeditor.load() }} --> <!-- Removed to avoid conflict -->
{% endblock %}
 
{% block parametres_content %}
  <h2>{{ 'Ajouter' if 'add' in request.path else 'Modifier' }} Compétence</h2>
  <form method="POST">
    {{ form.hidden_tag() }}
    
    <!-- Champ Programmes (multi-sélection) -->
    <div class="form-group">
      {{ form.programmes.label(class="form-label") }}
      {{ form.programmes(class="form-control", multiple=True) }}
    </div>
    
    <!-- Champ Code -->
    <div class="form-group">
      {{ form.code.label(class="form-label") }}
      {{ form.code(class="form-control") }}
    </div>
    
    <!-- Champ Nom -->
    <div class="form-group">
      {{ form.nom.label(class="form-label") }}
      {{ form.nom(class="form-control") }}
    </div>
    
    <div class="form-group">
      {{ form.criteria_de_performance.label(class="form-label") }}
      {{ form.criteria_de_performance(class="form-control toast-editor") }}
    </div>
    
    <div class="form-group">
      {{ form.contexte_de_realisation.label(class="form-label") }}
      {{ form.contexte_de_realisation(class="form-control toast-editor") }}
    </div>
    
    <!-- Bouton Soumettre -->
    <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
  </form>
{% endblock %}

{% block scripts %}
{% include '_easymde_assets.html' %}

<script>
function initToastEditor(textarea) {
    const mde = new EasyMDE({
        element: textarea,
        autoDownloadFontAwesome: false,
        spellChecker: false,
        autofocus: false,
        minHeight: '100px',
        status: false,
        forceSync: true,
        toolbar: ['bold','italic','|','unordered-list','ordered-list','|','guide'],
    });

    // Sync explicit
    mde.codemirror.on('change', () => { textarea.value = mde.value(); });

    // A11y: label association for CodeMirror inner textarea
    try {
        const cmInput = mde.codemirror.getInputField && mde.codemirror.getInputField();
        if (cmInput) {
            let labelEl = null;
            if (textarea.id) labelEl = document.querySelector(`label[for="${textarea.id}"]`);
            if (labelEl) {
                if (!labelEl.id) labelEl.id = `${textarea.id}-label`;
                cmInput.setAttribute('aria-labelledby', labelEl.id);
            } else if (textarea.getAttribute('placeholder')) {
                cmInput.setAttribute('aria-label', textarea.getAttribute('placeholder'));
            } else {
                cmInput.setAttribute('aria-label', 'Zone de texte');
            }
        }
    } catch {}

    const container = textarea.closest('.EasyMDEContainer') || textarea.parentElement;
    const toolbar = container ? container.querySelector('.editor-toolbar') : null;
    if (toolbar) toolbar.style.display = 'none';
    if (container) {
        container.addEventListener('focusin', () => { if (toolbar) toolbar.style.display = 'block'; });
        container.addEventListener('focusout', (e) => {
            if (!container.contains(e.relatedTarget) && toolbar) {
                const selection = window.getSelection();
                if (!selection.toString()) toolbar.style.display = 'none';
            }
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('textarea.toast-editor').forEach(function(textarea) {
        initToastEditor(textarea);
    });
});

// Style EasyMDE like Bootstrap inputs
const style = document.createElement('style');
style.innerHTML = `
    .EasyMDEContainer .CodeMirror,
    .EasyMDEContainer {
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 1rem;
        font-family: inherit;
    }
    .EasyMDEContainer .CodeMirror {
        padding: 4px 8px;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
