<!-- templates/view_programme.html -->
{% extends 'base.html' %}

{% block content %}
  <div class="container mt-5">
    <h2>{{ programme.nom }}</h2>

    <div class="mb-4">
      <p><strong>Total d'heures théoriques :</strong> {{ total_heures_theorie }} heures</p>
      <p><strong>Total d'heures pratiques :</strong> {{ total_heures_laboratoire }} heures</p>
      <p><strong>Total d'heures de travail à la maison :</strong> {{ total_heures_travail_maison }} heures</p>
      <p><strong>Total d'unités :</strong> {{ "%.2f"|format(total_unites) }}</p>
    </div>

    <!-- Afficher les Cours regroupés par Session -->
    <h3>Cours par Session</h3>
    <div class="table-responsive">
      <table class="table table-bordered table-striped" id="coursTable">
        <thead class="thead-dark">
          <tr>
            <th style="cursor: pointer;">Session</th>
            <th>Courses</th>
          </tr>
        </thead>
        <tbody>
          {% for session, cours_list in cours_par_session.items() %}
          <tr>
            <td>{{ session }}</td>
            <td>
              <div class="row">
                {% for c in cours_list %}
                <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-3">
                  <a href="{{ url_for('view_cours', cours_id=c.id) }}" class="card-link text-decoration-none text-reset">
                    <div class="card h-100">
                      <div class="card-header p-2" style="background-color: {{ c.fil_couleur if c.fil_conducteur_id else '#f2f2f2' }}; color: {{ 'white' if c.fil_conducteur_id else 'black' }};">
                        <strong>{{ c.code }}</strong> - {{ c.nom }}
                      </div>
                      <div class="card-body p-2">
                        <p><strong>Heures :</strong> {{ c.heures_theorie }} - {{ c.heures_laboratoire }} - {{ c.heures_travail_maison }}</p>
                        <p><strong>Compétences :</strong>
                          {% if competencies_codes[c.id] %}
                            {{ competencies_codes[c.id]|join(', ') }}
                          {% else %}
                            <em>Aucune</em>
                          {% endif %}
                        </p>
                        <p><strong>Prérequis :</strong>
                          {% if prerequisites[c.id] %}
                            {{ prerequisites[c.id]|join(', ') }}
                          {% else %}
                            <em>Aucun</em>
                          {% endif %}
                        </p>
                        <p><strong>Corequis :</strong>
                          {% if corequisites[c.id] %}
                            {{ corequisites[c.id]|join(', ') }}
                          {% else %}
                            <em>Aucun</em>
                          {% endif %}
                        </p>
                      </div>
                    </div>
                  </a>
                </div>
                {% endfor %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Bouton pour Ajouter un Nouveau Cours -->
    <a href="{{ url_for('add_cours') }}" class="btn btn-primary mb-4">Ajouter un Cours</a>

    <!-- Afficher les Compétences -->
    <h3>Compétences</h3>
    <ul class="list-group mb-4">
      {% for competence in competences %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <a href="{{ url_for('view_competence', competence_id=competence.id) }}">
              {{ competence.nom }}
            </a> ({{ competence.code }})
          </div>
          <div>
            <a href="{{ url_for('edit_competence', competence_id=competence.id) }}" class="btn btn-sm btn-warning">Modifier</a>
            
            <!-- Formulaire de Suppression -->
            <form action="{{ url_for('delete_competence', competence_id=competence.id) }}" method="POST" style="display: inline;">
              {{ delete_forms_competences[competence.id].hidden_tag() }}
              <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette compétence?');">Supprimer</button>
            </form>
          </div>
        </li>
      {% endfor %}
    </ul>

    <!-- Afficher les Fils Conducteurs -->
    <h3>Fils Conducteurs</h3>
    <ul class="list-group mb-4">
      {% for fil in fil_conducteurs %}
        <li class="list-group-item" style="background-color: {{ fil.couleur }}; color: {{ 'white' if fil.couleur else 'black' }};">
          {{ fil.description }}
        </li>
      {% endfor %}
    </ul>

    <a href="{{ url_for('add_fil_conducteur') }}" class="btn btn-primary">Ajouter un Fil Conducteur</a>

  </div>

  <!-- Ajout de styles personnalisés -->
  <style>
    /* Rendre toute la carte cliquable */
    .card-link {
      display: block;
      height: 100%;
      color: inherit;
    }
    .card-link:hover {
      text-decoration: none;
    }

    /* Styles pour rendre les cartes plus compactes */
    .card {
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      height: 100%;
      transition: transform 0.2s;
      padding: 0;
    }
    .card:hover {
      transform: scale(1.02);
    }
    .card-header {
      font-size: 0.9rem;
      padding: 0.4rem;
    }
    .card-body {
      padding: 0.4rem;
      font-size: 0.75rem;
    }
    .card-body p {
      margin-bottom: 0.2rem;
    }
    @media (max-width: 768px) {
      .card-body {
        font-size: 0.7rem;
      }
      .col-lg-2, .col-md-3, .col-sm-4, .col-6 {
        padding-left: 0.25rem;
        padding-right: 0.25rem;
      }
    }
  </style>

  <!-- Script de Tri (Optionnel) -->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
      const table = document.getElementById('coursTable');
      const headers = table.querySelectorAll('thead th');
      let currentSortColumn = null;
      let currentSortOrder = 'asc';

      headers.forEach((header, index) => {
          if (header.innerText.toLowerCase() === 'session') {  // Ajoutez uniquement le tri pour la colonne Session
              header.style.cursor = 'pointer';
              header.addEventListener('click', () => {
                  const sortKey = header.innerText.toLowerCase();

                  if (currentSortColumn === sortKey) {
                      currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
                  } else {
                      currentSortColumn = sortKey;
                      currentSortOrder = 'asc';
                  }

                  const tbody = table.querySelector('tbody');
                  const rows = Array.from(tbody.querySelectorAll('tr'));

                  rows.sort((a, b) => {
                      const aText = a.querySelectorAll('td')[0].innerText.trim();
                      const bText = b.querySelectorAll('td')[0].innerText.trim();

                      if (currentSortOrder === 'asc') {
                          return aText.localeCompare(bText);
                      } else {
                          return bText.localeCompare(aText);
                      }
                  });

                  rows.forEach(row => tbody.appendChild(row));
              });
          }
      });
  });
  </script>

{% endblock %}
