<!-- templates/view_programme.html -->
{% extends 'base.html' %}

{% block content %}
  <div class="container mt-5">
    <h2>{{ programme.nom }}</h2>

    <div class="mb-4">
      <p><strong>Total d'heures théoriques :</strong> {{ total_heures_theorie }} heures</p>
      <p><strong>Total d'heures pratiques :</strong> {{ total_heures_laboratoire }} heures</p>
      <p><strong>Total d'heures de travail à la maison :</strong> {{ total_heures_travail_maison }} heures</p>
      <p><strong>Total d'unités :</strong> {{ "%.2f"|format(total_unites) }}</p>
    </div>

    <!-- Afficher les Cours en premier -->
    <h3>Cours</h3>
    <table class="table table-striped table-bordered" id="coursTable">
      <thead class="thead-dark">
        <tr>
          <th data-sort-key="code" style="cursor:pointer;">Code</th>
          <th data-sort-key="nom" style="cursor:pointer;">Nom</th>
          <th data-sort-key="fil_conducteur" style="cursor:pointer;">Fil Conducteur</th>
          <th data-sort-key="nombre_unites" style="cursor:pointer;">Unités</th>
          <th data-sort-key="session" style="cursor:pointer;">Session</th>
          <th data-sort-key="heures_theorie" style="cursor:pointer;">Heures Théorie</th>
          <th data-sort-key="heures_laboratoire" style="cursor:pointer;">Heures Laboratoire</th>
          <th data-sort-key="heures_travail_maison" style="cursor:pointer;">Heures Travail Maison</th>
          <th>Cours Préalables</th>
          <th>Cours Corequis</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for c in cours %}
        <tr>
          <td data-value="{{ c.code }}">{{ c.code }}</td>
          <td data-value="{{ c.nom }}"><a href="{{ url_for('view_cours', cours_id=c.id) }}">{{ c.nom }}</a></td>
          <td data-value="{{ c.fil_description if c.fil_conducteur_id else '' }}" 
              style="background-color: {{ c.fil_couleur if c.fil_conducteur_id else 'transparent' }};">
              {% if c.fil_conducteur_id %}
                  {{ c.fil_description }}
              {% else %}
                  <em>Aucun</em>
              {% endif %}
          </td>

          <td data-value="{{ "%.2f"|format(c.nombre_unites) }}">{{ "%.2f"|format(c.nombre_unites) }}</td>
          <td data-value="{{ c.session }}">{{ c.session }}</td>
          <td data-value="{{ c.heures_theorie }}">{{ c.heures_theorie }}</td>
          <td data-value="{{ c.heures_laboratoire }}">{{ c.heures_laboratoire }}</td>
          <td data-value="{{ c.heures_travail_maison }}">{{ c.heures_travail_maison }}</td>
          <td>
            {% if prerequisites[c.id] %}
              <ul class="mb-0">
                {% for prereq, note in prerequisites[c.id] %}
                  <li>{{ prereq }} ({{ note }}%)</li>
                {% endfor %}
              </ul>
            {% else %}
              <em>Aucun</em>
            {% endif %}
          </td>
          <td>
            {% if corequisites[c.id] %}
              <ul class="mb-0">
                {% for coreq in corequisites[c.id] %}
                  <li>{{ coreq }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <em>Aucun</em>
            {% endif %}
          </td>
          <td>
            <a href="{{ url_for('edit_cours', cours_id=c.id) }}" class="btn btn-sm btn-warning">Modifier</a>
            <form action="{{ url_for('delete_cours', cours_id=c.id) }}" method="POST" style="display: inline;">
              {{ delete_forms_cours[c.id].hidden_tag() }}
              <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce cours?');">Supprimer</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Bouton pour Ajouter un Nouveau Cours -->
    <a href="{{ url_for('add_cours') }}" class="btn btn-primary mb-4">Ajouter un Cours</a>

    <!-- Afficher les Compétences -->
    <h3>Compétences</h3>
    <ul class="list-group mb-4">
      {% for competence in competences %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <a href="{{ url_for('view_competence', competence_id=competence.id) }}">
              {{ competence.nom }}
            </a> ({{ competence.code }})
          </div>
          <div>
            <a href="{{ url_for('edit_competence', competence_id=competence.id) }}" class="btn btn-sm btn-warning">Modifier</a>
            
            <!-- Formulaire de Suppression -->
            <form action="{{ url_for('delete_competence', competence_id=competence.id) }}" method="POST" style="display: inline;">
              {{ delete_forms_competences[competence.id].hidden_tag() }}
              <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette compétence?');">Supprimer</button>
            </form>
          </div>
        </li>
      {% endfor %}
    </ul>

    <!-- Afficher les Fils Conducteurs -->
    <h3>Fils Conducteurs</h3>
    <ul class="list-group mb-4">
      {% for fil in fil_conducteurs %}
        <li class="list-group-item" style="background-color: {{ fil.couleur }};">
          {{ fil.description }}
        </li>
      {% endfor %}
    </ul>

    <a href="{{ url_for('add_fil_conducteur') }}" class="btn btn-primary">Ajouter un Fil Conducteur</a>

  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
      const table = document.getElementById('coursTable');
      const headers = table.querySelectorAll('thead th[data-sort-key]');
      let currentSortColumn = null;
      let currentSortOrder = 'asc';

      headers.forEach(header => {
          header.addEventListener('click', () => {
              const sortKey = header.getAttribute('data-sort-key');

              // Déterminer le nouvel ordre de tri
              if (currentSortColumn === sortKey) {
                  currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
              } else {
                  currentSortColumn = sortKey;
                  currentSortOrder = 'asc';
              }

              const tbody = table.querySelector('tbody');
              const rows = Array.from(tbody.querySelectorAll('tr'));

              rows.sort((a, b) => {
                  let aVal, bVal;

                  switch(sortKey) {
                      case 'fil_conducteur':
                          aVal = a.querySelector(`td:nth-of-type(${getColumnIndex('fil_conducteur')})`).getAttribute('data-value') || '';
                          bVal = b.querySelector(`td:nth-of-type(${getColumnIndex('fil_conducteur')})`).getAttribute('data-value') || '';
                          break;
                      default:
                          aVal = a.querySelector(`td[data-value][data-sort-key="${sortKey}"]`) ? 
                                 a.querySelector(`td[data-value][data-sort-key="${sortKey}"]`).getAttribute('data-value') : 
                                 a.querySelector(`td:nth-of-type(${getColumnIndex(sortKey)})`).getAttribute('data-value');
                          bVal = b.querySelector(`td[data-value][data-sort-key="${sortKey}"]`) ? 
                                 b.querySelector(`td[data-value][data-sort-key="${sortKey}"]`).getAttribute('data-value') : 
                                 b.querySelector(`td:nth-of-type(${getColumnIndex(sortKey)})`).getAttribute('data-value');
                  }

                  // Conversion en nombre si possible
                  let aNum = parseFloat(aVal.replace(',', '.'));
                  let bNum = parseFloat(bVal.replace(',', '.'));
                  if (!isNaN(aNum) && !isNaN(bNum)) {
                      aVal = aNum;
                      bVal = bNum;
                  } else {
                      aVal = aVal.toString().toLowerCase();
                      bVal = bVal.toString().toLowerCase();
                  }

                  if (aVal < bVal) {
                      return currentSortOrder === 'asc' ? -1 : 1;
                  } else if (aVal > bVal) {
                      return currentSortOrder === 'asc' ? 1 : -1;
                  } else {
                      return 0;
                  }
              });

              // Réinsère les lignes triées dans le tbody
              rows.forEach(row => tbody.appendChild(row));
          });
      });

      // Fonction pour obtenir l'indice de la colonne basé sur le sortKey
      function getColumnIndex(sortKey) {
          const header = table.querySelector(`thead th[data-sort-key="${sortKey}"]`);
          if (!header) return -1;
          return Array.from(header.parentNode.children).indexOf(header) + 1;
      }

      // Simuler un clic sur la colonne "Session" pour un tri par défaut
      const defaultSortHeader = table.querySelector('thead th[data-sort-key="session"]');
      if (defaultSortHeader) {
          defaultSortHeader.click();
      }
  });
  </script>

{% endblock %}
