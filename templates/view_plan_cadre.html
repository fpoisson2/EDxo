<!-- templates/view_plan_cadre.html -->
{% extends 'base.html' %}

{% block content %}

<div class="container mt-5">

    <div id="flash-message" class="alert d-none" role="alert">
        <!-- Le contenu du message sera injecté par JavaScript -->
    </div>
    
    <!-- Titre du Cours -->
    <div class="mb-4">
        <h1 class="text-center">Plan-cadre pour le cours: {{ cours.code }} - {{ cours.nom }}</h1>
    </div>

    <!-- Boutons d'Action Supplémentaires -->
    <div class="d-flex gap-3 mb-5 align-items-center">
        <a href="{{ url_for('plan_cadre.edit_plan_cadre', plan_id=plan.id) }}" class="btn btn-primary d-flex align-items-center">
            <i class="bi bi-pencil-square me-2"></i> Éditer le plan-cadre
        </a>
        <button type="button" class="btn btn-success d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#generateModal">
            <i class="bi bi-box-arrow-up-right me-2"></i>
            <span class="btn-text">Générer le plan-cadre</span>
            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" id="loadingSpinner">
                <span class="visually-hidden">Chargement...</span>
            </span>
        </button>
    </div>

    <div class="accordion" id="planCadreAccordion">
        <!-- Partie 1: Identification du cours -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingGeneralInfo">
                <button class="accordion-button bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGeneralInfo" aria-expanded="true" aria-controls="collapseGeneralInfo">
                    Partie 1 - Identification du cours
                </button>
            </h2>
            <div id="collapseGeneralInfo" class="accordion-collapse collapse show" aria-labelledby="headingGeneralInfo" data-bs-parent="#planCadreAccordion">
                <div class="accordion-body">
                    <p><strong>Programme :</strong> {{ cours.programme_nom }}</p>
                    <p><strong>Code :</strong> {{ cours.code }}</p>
                    <p><strong>Nombre d'unités :</strong> {{ cours.nombre_unites | round(2) }}</p>
                    <p><strong>Session :</strong> {{ cours.session }}</p>
                    <p><strong>Heures de théorie :</strong> {{ cours.heures_theorie }}</p>
                    <p><strong>Heures de laboratoire :</strong> {{ cours.heures_laboratoire }}</p>
                    <p><strong>Heures de travail à la maison :</strong> {{ cours.heures_travail_maison }}</p>
                    <p><strong>Cours préalables :</strong>
                        {% if prealables_details %}
                            <ul class="list-group">
                                {% for pre in prealables_details %}
                                    <li class="list-group-item">
                                        <a href="{{ url_for('cours.view_cours', cours_id=pre.id) }}" class="text-decoration-none">{{ pre.nom }}</a> (Code: {{ pre.code }})
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>Aucun cours préalable.</p>
                        {% endif %}
                    </p>
                    <p><strong>Cours corequis :</strong>
                        {% if corequisites_details %}
                            <ul class="list-group">
                                {% for core in corequisites_details %}
                                    <li class="list-group-item">
                                        <a href="{{ url_for('cours.view_cours', cours_id=core.id) }}" class="text-decoration-none">{{ core.nom }}</a> (Code: {{ core.code }})
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>Aucun cours corequis.</p>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- Partie 2 - Repères généraux au sujet du cours -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingIntroduction">
                <button class="accordion-button bg-primary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIntroduction" aria-expanded="true" aria-controls="collapseIntroduction">
                    Partie 2 - Repères généraux au sujet du cours
                </button>
            </h2>
            <div id="collapseIntroduction" class="accordion-collapse collapse show" aria-labelledby="headingIntroduction" data-bs-parent="#planCadreAccordion">
                <div class="accordion-body">
                    <!-- Ajout du Titre "Place et rôle du cours dans le programme" -->
                    <strong class="d-block mb-3">Place et rôle du cours dans le programme</strong>
                    
                    <div id="intro-container">
                        <p id="intro-text" contenteditable="false" style="cursor: pointer;">{{ plan.place_intro or "Non renseigné." }}</p>
                        <!-- Boutons Sauvegarder et Annuler, cachés par défaut -->
                        <button id="save-intro-btn" class="btn btn-sm btn-success" style="display: none;">Sauvegarder</button>
                        <button id="cancel-intro-btn" class="btn btn-sm btn-danger" style="display: none;">Annuler</button>
                    </div>
                    
                    <!-- Compétences Développées -->
                    <div class="mt-4">
                        <strong>Compétences développées</strong>
                        {% if competences_developpees %}
                            <ul class="list-group list-group-flush">
                                {% for comp in competences_developpees %}
                                    <li class="list-group-item">
                                        <strong>{{ comp.texte }}</strong>: {{ comp.description or "Pas de description." }}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>Aucune compétence développée.</p>
                        {% endif %}
                    </div>

                    <!-- Objets Cibles -->
                    <div class="mt-4">
                        <strong>Objets Cibles</strong>
                        {% if objets_cibles %}
                            <ul class="list-group list-group-flush">
                                {% for objet in objets_cibles %}
                                    <li class="list-group-item">
                                        <strong>{{ objet.texte }}</strong>: {{ objet.description or "Pas de description." }}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>Aucun objet cible.</p>
                        {% endif %}
                    </div>

                    <!-- Compétences Certifiées -->
                    <div class="mt-4">
                        <strong>Compétences certifiées</strong>
                        {% if competences_certifiees %}
                            <ul class="list-group list-group-flush">
                                {% for cc in competences_certifiees %}
                                    <li class="list-group-item">
                                        <strong>{{ cc.texte }}</strong>: {{ cc.description or "Pas de description." }}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>Aucune compétence certifiée.</p>
                        {% endif %}
                    </div>

                    <!-- Cours Corequis -->
                    <div class="mt-4">
                        <strong>Cours Corequis</strong>
                        {% if cours_corequis %}
                            <ul class="list-group list-group-flush">
                                {% for cc in cours_corequis %}
                                    <li class="list-group-item">
                                        <strong>{{ cc.texte }}</strong>: {{ cc.description or "Pas de description." }}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>Aucun cours corequis.</p>
                        {% endif %}
                    </div>

                    <!-- Cours Préalables -->
                    <div class="mt-4">
                        <strong>Cours Préalables</strong>
                        {% if cours_prealables %}
                            <ul class="list-group list-group-flush">
                                {% for cp in cours_prealables %}
                                    <li class="list-group-item">
                                        <strong>{{ cp.texte }}</strong>: {{ cp.description or "Non spécifiée." }}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>Aucun cours préalable.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Partie 3 - Résultats visés -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingResultatsVises">
                <button class="accordion-button bg-info text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseResultatsVises" aria-expanded="true" aria-controls="collapseResultatsVises">
                    Partie 3 - Résultats visés
                </button>
            </h2>
            <div id="collapseResultatsVises" class="accordion-collapse collapse show" aria-labelledby="headingResultatsVises" data-bs-parent="#planCadreAccordion">
                <div class="accordion-body">
                    <!-- Objectif Terminal -->
                    <div class="mb-4">
                        <strong>Objectif terminal</strong>
                        <p>{{ plan.objectif_terminal or "Non renseigné." }}</p>
                    </div>

                    <!-- Liste des Capacités -->
                    <div class="mb-4">
                        <strong>Capacités</strong>
                        {% if capacites %}
                            <ul class="list-group list-group-flush">
                                {% for cap in capacites %}
                                    <li class="list-group-item">
                                        <strong>{{ cap['capacite']['capacite'] }}</strong>
                                        <p>{{ cap['capacite']['description_capacite'] or "Pas de description." }}</p>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>Aucune capacité ajoutée.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Partie 4 - Indications relatives à l’organisation de l’apprentissage et de l’enseignement -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOrganisation">
                <button class="accordion-button bg-secondary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOrganisation" aria-expanded="true" aria-controls="collapseOrganisation">
                    Partie 4 - Indications relatives à l’organisation de l’apprentissage et de l’enseignement
                </button>
            </h2>
            <div id="collapseOrganisation" class="accordion-collapse collapse show" aria-labelledby="headingOrganisation" data-bs-parent="#planCadreAccordion">
                <div class="accordion-body">
                    <!-- Structure du Cours -->
                    <div class="mb-4">
                        <strong>Structure du cours</strong>
                        <p>{{ plan.structure_intro or "Non renseignée." }}</p>
                    </div>

                    <!-- Activités Théoriques -->
                    <div class="mb-4">
                        <strong>Activités théoriques</strong>
                        <p>{{ plan.structure_activites_theoriques or "Non renseignées." }}</p>
                    </div>

                    <!-- Activités Pratiques -->
                    <div class="mb-4">
                        <strong>Activités pratiques</strong>
                        <p>{{ plan.structure_activites_pratiques or "Non renseignées." }}</p>
                    </div>

                    <!-- Organisation du Cours -->
                    <div class="mb-4">
                        <strong>Organisation du cours</strong>
                        <p>{{ plan.structure_activites_prevues | markdown | safe or "Non renseignée." }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Partie 5 - Indications relatives à l’évaluation des apprentissages -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingEvaluation">
                <button class="accordion-button bg-warning text-dark" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEvaluation" aria-expanded="true" aria-controls="collapseEvaluation">
                    Partie 5 - Indications relatives à l’évaluation des apprentissages
                </button>
            </h2>
            <div id="collapseEvaluation" class="accordion-collapse collapse show" aria-labelledby="headingEvaluation" data-bs-parent="#planCadreAccordion">
                <div class="accordion-body">
                    <!-- Évaluation sommative des apprentissages -->
                    <div class="mb-4">
                        <strong>Évaluation sommative des apprentissages</strong>
                        <p>{{ plan.eval_evaluation_sommative or "Non renseignée." }}</p>
                    </div>

                    <!-- Nature des évaluations sommatives -->
                    <div class="mb-4">
                        <strong>Nature des évaluations sommatives</strong>
                        <p>{{ plan.eval_nature_evaluations_sommatives or "Non renseignée." }}</p>
                    </div>

                    <!-- Évaluation de la langue -->
                    <div class="mb-4">
                        <strong>Évaluation de la langue</strong>
                        <p>{{ plan.eval_evaluation_de_la_langue or "Non renseignée." }}</p>
                    </div>

                    <!-- Évaluation formative des apprentissages -->
                    <div class="mb-4">
                        <strong>Évaluation formative des apprentissages</strong>
                        <p>{{ plan.eval_evaluation_sommatives_apprentissages | markdown | safe or "Non renseignée." }}</p>
                    </div>

                    <!-- Informations détaillées sur les Capacités et Savoir-être -->
                    <div class="mb-4">
                        <strong>Capacités</strong>
                        {% if capacites %}
                            <!-- Accordéon Intérieur pour Capacités -->
                            <div class="accordion mb-3" id="capacitesAccordionEvaluation">
                                {% for cap in capacites %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingCapaciteEval{{ cap['capacite']['id'] }}">
                                            <button class="accordion-button bg-light text-dark" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCapaciteEval{{ cap['capacite']['id'] }}" aria-expanded="true" aria-controls="collapseCapaciteEval{{ cap['capacite']['id'] }}">
                                                {{ cap['capacite']['capacite'] }} (Pondération: {{ cap['capacite']['ponderation_min'] }}% - {{ cap['capacite']['ponderation_max'] }}%)
                                            </button>
                                        </h2>
                                        <div id="collapseCapaciteEval{{ cap['capacite']['id'] }}" class="accordion-collapse collapse show" aria-labelledby="headingCapaciteEval{{ cap['capacite']['id'] }}" data-bs-parent="#capacitesAccordionEvaluation">
                                            <div class="accordion-body">
                                                <p>{{ cap['capacite']['description_capacite'] or "Pas de description." }}</p>
                                                
                                                <!-- Sous-Accordion pour Savoirs Nécessaires -->
                                                <div class="accordion mb-3" id="savoirsNecessairesAccordionEval{{ cap['capacite']['id'] }}">
                                                    <div class="accordion-item">
                                                        <h2 class="accordion-header" id="headingSavoirsNecessairesEval{{ cap['capacite']['id'] }}">
                                                            <button class="accordion-button bg-secondary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSavoirsNecessairesEval{{ cap['capacite']['id'] }}" aria-expanded="true" aria-controls="collapseSavoirsNecessairesEval{{ cap['capacite']['id'] }}">
                                                                Savoirs Nécessaires
                                                            </button>
                                                        </h2>
                                                        <div id="collapseSavoirsNecessairesEval{{ cap['capacite']['id'] }}" class="accordion-collapse collapse show" aria-labelledby="headingSavoirsNecessairesEval{{ cap['capacite']['id'] }}" data-bs-parent="#savoirsNecessairesAccordionEval{{ cap['capacite']['id'] }}">
                                                            <div class="accordion-body">
                                                                {% if cap['savoirs_necessaires'] %}
                                                                    <ul class="list-group list-group-flush">
                                                                        {% for sav in cap['savoirs_necessaires'] %}
                                                                            <li class="list-group-item">{{ sav.texte }}</li>
                                                                        {% endfor %}
                                                                    </ul>
                                                                {% else %}
                                                                    <p>Aucun savoir nécessaire.</p>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Sous-Accordion pour Savoirs Faire -->
                                                <div class="accordion mb-3" id="savoirsFaireAccordionEval{{ cap['capacite']['id'] }}">
                                                    <div class="accordion-item">
                                                        <h2 class="accordion-header" id="headingSavoirsFaireEval{{ cap['capacite']['id'] }}">
                                                            <button class="accordion-button bg-secondary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSavoirsFaireEval{{ cap['capacite']['id'] }}" aria-expanded="true" aria-controls="collapseSavoirsFaireEval{{ cap['capacite']['id'] }}">
                                                                Savoirs Faire
                                                            </button>
                                                        </h2>
                                                        <div id="collapseSavoirsFaireEval{{ cap['capacite']['id'] }}" class="accordion-collapse collapse show" aria-labelledby="headingSavoirsFaireEval{{ cap['capacite']['id'] }}" data-bs-parent="#savoirsFaireAccordionEval{{ cap['capacite']['id'] }}">
                                                            <div class="accordion-body">
                                                                {% if cap['savoirs_faire'] %}
                                                                    <ul class="list-group list-group-flush">
                                                                        {% for sf in cap['savoirs_faire'] %}
                                                                            <li class="list-group-item">
                                                                                {{ sf.texte }} 
                                                                                <span class="badge bg-success">Cible: {{ sf.cible }}</span> 
                                                                                <span class="badge bg-warning text-dark">Seuil: {{ sf.seuil_reussite }}</span>
                                                                            </li>
                                                                        {% endfor %}
                                                                    </ul>
                                                                {% else %}
                                                                    <p>Aucun savoir faire.</p>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Sous-Accordion pour Moyens d'Évaluation -->
                                                <div class="accordion mb-3" id="moyensEvaluationAccordionEval{{ cap['capacite']['id'] }}">
                                                    <div class="accordion-item">
                                                        <h2 class="accordion-header" id="headingMoyensEvaluationEval{{ cap['capacite']['id'] }}">
                                                            <button class="accordion-button bg-secondary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMoyensEvaluationEval{{ cap['capacite']['id'] }}" aria-expanded="true" aria-controls="collapseMoyensEvaluationEval{{ cap['capacite']['id'] }}">
                                                                Moyens d'Évaluation
                                                            </button>
                                                        </h2>
                                                        <div id="collapseMoyensEvaluationEval{{ cap['capacite']['id'] }}" class="accordion-collapse collapse show" aria-labelledby="headingMoyensEvaluationEval{{ cap['capacite']['id'] }}" data-bs-parent="#moyensEvaluationAccordionEval{{ cap['capacite']['id'] }}">
                                                            <div class="accordion-body">
                                                                {% if cap['moyens_evaluation'] %}
                                                                    <ul class="list-group list-group-flush">
                                                                        {% for me in cap['moyens_evaluation'] %}
                                                                            <li class="list-group-item">{{ me.texte }}</li>
                                                                        {% endfor %}
                                                                    </ul>
                                                                {% else %}
                                                                    <p>Aucun moyen d'évaluation.</p>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Boutons d'Action -->
                                                <div class="mt-2">
                                                    <a href="{{ url_for('cours.edit_capacite', cours_id=plan.cours_id, plan_id=plan.id, capacite_id=cap['capacite']['id']) }}" class="btn btn-primary btn-sm">Éditer</a>
                                                    <form method="POST" action="{{ url_for('plan_cadre.delete_capacite', plan_id=plan.id, capacite_id=cap['capacite']['id']) }}" style="display:inline;">
                                                        {{ delete_forms_capacites[cap['capacite']['id']].hidden_tag() }}
                                                        <button type="submit" class="btn btn-danger btn-sm">Supprimer</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p>Aucune capacité ajoutée.</p>
                        {% endif %}
                    </div>

                    <!-- Savoir-être -->
                    <div class="mb-4">
                        <strong>Savoir-être</strong>
                        {% if savoir_etre %}
                            <ul class="list-group list-group-flush">
                                {% for se in savoir_etre %}
                                    <li class="list-group-item">{{ se.texte }}</li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>Aucun savoir-être.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Partie 6: Capacités (Accordéon Détail) -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingElementsCompetence">
                <button class="accordion-button bg-primary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseElementsCompetence" aria-expanded="true" aria-controls="collapseElementsCompetence">
                    Partie 6 - Précisions sur le développement de la ou des compétences associées au cours 
                </button>
            </h2>
            <div id="collapseElementsCompetence" class="accordion-collapse collapse show" aria-labelledby="headingElementsCompetence" data-bs-parent="#planCadreAccordion">
                <div class="accordion-body">
                    {% if elements_competence_par_cours %}
                        <ul class="list-group">
                            {% for competence_id, competence_data in elements_competence_par_cours.items() %}
                                <li class="list-group-item">
                                    <strong>
                                        <a href="{{ url_for('programme.view_competence', competence_id=competence_id) }}" class="text-decoration-none">
                                            {{ competence_data.nom }} ({{ competence_data.code }})
                                        </a>
                                    </strong>
                                    <ul class="mt-2">
                                        {% for ec in competence_data.elements %}
                                            <li>{{ ec.element_competence_nom }} <span class="badge bg-secondary">Statut : {{ ec.status }}</span></li>
                                        {% endfor %}
                                    </ul>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>Aucun élément de compétence.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Gestion des Fichiers -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingGestionFichiers">
                <button class="accordion-button bg-dark text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGestionFichiers" aria-expanded="true" aria-controls="collapseGestionFichiers">
                    Gestion des Fichiers
                </button>
            </h2>
            <div id="collapseGestionFichiers" class="accordion-collapse collapse show" aria-labelledby="headingGestionFichiers" data-bs-parent="#planCadreAccordion">
                <div class="accordion-body">
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <a href="{{ url_for('plan_cadre.export_plan_cadre', plan_id=plan_id) }}" class="btn btn-primary">Exporter en DOCX</a>
                        <a href="{{ url_for('cours.export_plan_cadre_json', cours_id=cours_id, plan_id=plan_id) }}" class="btn btn-secondary">Exporter en JSON</a>
                    </div>
                    <hr>
                    <form method="POST" enctype="multipart/form-data" action="{{ url_for('cours.import_plan_cadre_json', cours_id=cours_id, plan_id=plan_id) }}">
                        {{ import_form.hidden_tag() }}
                        <div class="mb-3">
                            {{ import_form.json_file.label(class="form-label") }}
                            {{ import_form.json_file(class="form-control") }}
                            {% for error in import_form.json_file.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div>
                            {{ import_form.submit(class="btn btn-success") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Boutons d'Action Supplémentaires (répétition) -->
    <div class="d-flex gap-2 mt-5">
        <a href="{{ url_for('plan_cadre.edit_plan_cadre', plan_id=plan.id) }}" class="btn btn-primary">Éditer le plan-cadre</a>
        <a href="{{ url_for('cours.view_cours', cours_id=plan.cours_id) }}" class="btn btn-secondary">Retour au cours</a>
    </div>
    
    <!-- Modal Génération du Plan-cadre -->
    <div class="modal fade" id="generateModal" tabindex="-1" aria-labelledby="generateModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="{{ url_for('plan_cadre.generate_plan_cadre_content', plan_id=plan.id) }}" method="post" id="generateContentForm">
                    {{ generate_form.hidden_tag() }}
                    <div class="modal-header">
                        <h5 class="modal-title" id="generateModalLabel">Générer le plan-cadre</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            {{ generate_form.additional_info.label(class="form-label") }}
                            {{ generate_form.additional_info(class="form-control", rows="3") }}
                            {% for error in generate_form.additional_info.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="mb-3">
                            {{ generate_form.ai_model.label(class="form-label") }}
                            {{ generate_form.ai_model(class="form-select") }}
                            {% for error in generate_form.ai_model.errors %}
                                <div class="text-danger">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary" id="confirmGenerateBtn">
                            <span class="btn-text">Générer le plan-cadre</span>
                            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" id="modalLoadingSpinner">
                                <span class="visually-hidden">Chargement...</span>
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion de la génération du plan-cadre
    const generateContentForm = document.getElementById('generateContentForm');
    const confirmGenerateBtn = document.getElementById('confirmGenerateBtn');
    const modalLoadingSpinner = document.getElementById('modalLoadingSpinner');

    generateContentForm.addEventListener('submit', function(e) {
        // Désactiver le bouton pour éviter les soumissions multiples
        confirmGenerateBtn.disabled = true;

        // Afficher le spinner
        modalLoadingSpinner.classList.remove('d-none');
    });

    // Gestion du formulaire d'édition de l'introduction
    const introText = document.getElementById('intro-text');
    const saveBtn = document.getElementById('save-intro-btn');
    const cancelBtn = document.getElementById('cancel-intro-btn');
    const flashMessage = document.getElementById('flash-message');
    let originalText = introText.innerHTML;

    // Fetch CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Fonction pour afficher le message flash
    function showFlashMessage(message, type) {
        flashMessage.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-warning', 'alert-info');
        flashMessage.classList.add(`alert-${type}`);
        flashMessage.textContent = message;

        // Faire disparaître le message après 5 secondes
        setTimeout(() => {
            flashMessage.classList.add('d-none');
        }, 5000);
    }

    // Handle click on the paragraph to enable editing
    introText.addEventListener('click', function () {
        introText.contentEditable = "true";
        introText.focus();
        // Change cursor to text
        introText.style.cursor = 'text';
        // Show Save and Cancel buttons
        saveBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
    });

    // Handle the save button click
    saveBtn.addEventListener('click', function () {
        const updatedText = introText.innerHTML.trim();
        // Send the updated text via AJAX
        fetch('{{ url_for("cours.update_intro", cours_id=cours_id, plan_id=plan_id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken  // Include CSRF token in headers
            },
            body: JSON.stringify({ place_intro: updatedText })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                introText.contentEditable = "false";
                // Revert cursor
                introText.style.cursor = 'pointer';
                saveBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
                originalText = updatedText;  // Update original text

                // Afficher un message de succès
                showFlashMessage('Introduction mise à jour avec succès.', 'success');
            } else {
                // Afficher un message d'erreur
                showFlashMessage(data.message || 'Erreur lors de la mise à jour de l\'introduction.', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Afficher un message d'erreur générique
            showFlashMessage('Erreur lors de la mise à jour de l\'introduction.', 'danger');
        });
    });

    // Handle the cancel button click
    cancelBtn.addEventListener('click', function () {
        introText.innerHTML = originalText;
        introText.contentEditable = "false";
        // Revert cursor
        introText.style.cursor = 'pointer';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';

        // Afficher un message indiquant que l'édition a été annulée
        showFlashMessage('Modification annulée.', 'warning');
    });
});
</script>
<style>
    /* Style pour le texte en mode édition */
    #intro-text[contenteditable="true"] {
        border: 1px solid #ced4da;
        padding: 5px;
        background-color: #f8f9fa;
    }
</style>
{% endblock %}
